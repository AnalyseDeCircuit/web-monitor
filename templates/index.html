<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Advanced System Monitor - Real-time CPU, Memory, GPU, Network, Docker, and SSH monitoring">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="System Monitor">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23121212' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='%23ff4757' text-anchor='middle' dominant-baseline='central'>M</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23121212' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='%23ff4757' text-anchor='middle' dominant-baseline='central'>M</text></svg>">
    <title>System Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent-cpu: #ff4757;
            --accent-mem: #2ed573;
            --accent-net: #1e90ff;
            --accent-disk: #ffa502;
            --accent-temp: #ff6b81;
            --border-radius: 12px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #181818;
            border-right: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            position: relative;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 70px;
            padding: 20px 10px;
        }

        .sidebar.collapsed .sidebar-title span,
        .sidebar.collapsed .nav-item span {
            display: none;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
        }

        .sidebar-toggle {
            position: relative;
            top: auto;
            right: auto;
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            margin-left: auto;
            margin-bottom: 15px;
        }

        .sidebar.collapsed .sidebar-toggle {
            right: auto;
        }

        .sidebar-toggle:hover {
            color: var(--accent-cpu);
            transform: scale(1.1);
        }

        /* Mobile Menu Hamburger Button */
        .mobile-menu-btn {
            display: none !important;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-main);
            cursor: pointer;
            font-size: 1.3rem;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn:hover {
            background: rgba(255,255,255,0.15);
            color: var(--accent-cpu);
        }

        .mobile-menu-btn.active {
            background: var(--accent-cpu);
            color: white;
        }

        .net-tab {
            background: rgba(255,255,255,0.05);
            border: none;
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .net-tab.active {
            background: var(--accent-net);
            color: white;
        }
        .net-tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-start;
            white-space: nowrap;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: var(--text-main);
        }

        .nav-item.active {
            background-color: rgba(255, 71, 87, 0.1);
            color: var(--accent-cpu);
        }

        .nav-item i {
            min-width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #ff4757, #2ed573);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .boot-time {
            font-size: 0.8rem;
            color: var(--text-dim);
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            body {
                padding: 10px;
            }
            .sidebar {
                width: 60px;
                padding: 15px 8px;
            }
            .sidebar.collapsed {
                width: 60px;
            }
            .sidebar-title span,
            .sidebar.collapsed .sidebar-title span,
            .nav-item span,
            .sidebar.collapsed .nav-item span {
                display: none;
            }
            .nav-item,
            .sidebar .nav-item {
                padding: 12px;
                justify-content: center;
            }
            .sidebar-title {
                margin-bottom: 20px;
                margin-right: 0;
            }
            .sidebar-toggle {
                right: 8px;
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.1);
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 10px;
        }

        .stat-group {
            margin-bottom: 15px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bg {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Specific Colors */
        .cpu-fill { background: var(--accent-cpu); box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }
        .mem-fill { background: var(--accent-mem); box-shadow: 0 0 10px rgba(46, 213, 115, 0.3); }
        .disk-fill { background: var(--accent-disk); }
        .temp-fill { background: var(--accent-temp); }

        /* Process 页面样式 */
        .sort-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sort-btn:hover {
            background: rgba(255,255,255,0.15);
            color: var(--text-main);
        }

        .sort-btn.active {
            background: rgba(255, 71, 87, 0.3);
            color: var(--accent-cpu);
            border-color: var(--accent-cpu);
        }

        .process-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .process-item:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }

        .process-item.level-0 { margin-left: 0; }
        .process-item.level-1 { margin-left: 20px; }
        .process-item.level-2 { margin-left: 40px; }
        .process-item.level-3 { margin-left: 60px; }
        .process-item.level-4 { margin-left: 80px; }

        .process-icon {
            min-width: 30px;
            text-align: center;
            color: var(--accent-cpu);
            margin-right: 10px;
        }

        .process-info {
            flex: 1;
            min-width: 0;
        }

        .process-name {
            font-weight: bold;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .process-meta {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 4px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .process-bars {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 200px;
        }

        .process-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.75rem;
        }

        .process-bar-label {
            color: var(--text-dim);
        }

        .process-bar-bg {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .process-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .cpu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .core-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .core-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            margin-top: 8px;
            border-radius: 3px;
            overflow: hidden;
            width: 100%;
        }
        
        .core-fill {
            height: 100%;
            background: var(--accent-cpu);
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
        }

        .sensor-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        #sensors-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .sensor-box {
            /* Keep class for compatibility; use compact list style */
            background: transparent;
            padding: 0;
            border-radius: 0;
        }

        

        .sensor-dragging {
            opacity: 0.6;
            cursor: grabbing;
        }

        .sensor-drop-target {
            outline: 1px dashed rgba(255,255,255,0.2);
            outline-offset: 3px;
        }

        .sensor-value {
            font-weight: bold;
        }

        .network-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .network-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .net-box {
            background: rgba(30, 144, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(30, 144, 255, 0.2);
        }

        .net-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-net);
            margin-top: 5px;
        }

        .disk-item {
            margin-bottom: 15px;
        }
        
        .disk-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .freq-badge {
            background: rgba(255, 71, 87, 0.1);
            color: var(--accent-cpu);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4757; /* Red by default */
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
            transition: background-color 0.3s, box-shadow 0.3s;
            display: inline-block;
        }

        .status-dot.connected {
            background-color: #2ed573; /* Green */
            box-shadow: 0 0 10px rgba(46, 213, 115, 0.5);
        }

        /* Fastfetch Style */
        .fastfetch-container {
            display: flex;
            align-items: center;
            gap: 30px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .ascii-logo {
            color: var(--accent-net);
            font-weight: bold;
            font-size: 0.8rem;
            line-height: 1.2;
            white-space: pre;
        }

        .sys-info-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.9rem;
        }

        .sys-key {
            color: var(--accent-mem);
            font-weight: bold;
            min-width: 100px;
            display: inline-block;
        }

        .sys-val {
            color: var(--text-main);
        }

        /* Scrollbar styling for processes */
        #processes-container::-webkit-scrollbar,
        .cpu-grid::-webkit-scrollbar,
        #sensors-container::-webkit-scrollbar {
            width: 6px;
        }
        #processes-container::-webkit-scrollbar-track,
        .cpu-grid::-webkit-scrollbar-track,
        #sensors-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        #processes-container::-webkit-scrollbar-thumb,
        .cpu-grid::-webkit-scrollbar-thumb,
        #sensors-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        #processes-container::-webkit-scrollbar-thumb:hover,
        .cpu-grid::-webkit-scrollbar-thumb:hover,
        #sensors-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* GPU Styles */
        .gpu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
        .gpu-name { font-size: 1.1rem; font-weight: bold; color: var(--accent-net); }
        .gpu-meta { font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }
        .gpu-temp { font-size: 1.2rem; font-weight: bold; color: var(--accent-temp); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.75rem; color: var(--text-dim); display: block; }
        .stat-value { font-size: 1rem; font-weight: bold; }
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 20px; }
        .vram-container { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .vram-details { flex: 1; }
        .vram-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .vram-bar-fill { height: 100%; background: var(--accent-mem); width: 0%; transition: width 0.5s; }

        /* === RESPONSIVE DESIGN === */
        
        /* Tablet (768px and below) */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .mobile-menu-btn {
                display: flex !important;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 0;
                overflow: hidden;
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                z-index: 999;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                padding: 10px 0;
                flex-direction: column;
                flex-wrap: nowrap;
                transition: max-height 0.3s ease;
            }
            
            .sidebar.mobile-open {
                max-height: calc(100vh - 60px);
                overflow-y: auto;
            }
            
            .sidebar-title {
                display: none;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .main-content {
                flex: 1;
                width: 100%;
                padding-top: 60px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
                margin: 0;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .network-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .fastfetch-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .ascii-logo {
                display: none;
            }
        }
        
        /* Mobile (480px and below) */
        @media (max-width: 480px) {
            :root {
                font-size: 14px;
            }
            
            body {
                padding-top: 0;
            }
            
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .header select {
                font-size: 0.75rem;
                padding: 4px !important;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 8px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 0;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .network-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-group {
                margin-bottom: 10px;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .progress-bg {
                height: 6px;
            }
            
            .nav-item {
                padding: 10px;
                margin-bottom: 2px;
                font-size: 0.9rem;
            }
            
            .nav-item span {
                display: none;
            }
            
            .nav-item.active span {
                display: inline;
            }
            
            .sidebar {
                flex-direction: column;
                align-items: center;
                max-height: 0;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .sidebar.mobile-open {
                max-height: calc(100vh - 60px);
            }
            
            .net-tab {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            table td, table th {
                padding: 5px !important;
            }
            
            .process-item {
                padding: 8px;
            }
            
            .sensor-item {
                padding: 6px;
            }
            
            .chart-container {
                height: 150px;
            }
            
            button {
                font-size: 0.85rem;
                padding: 6px 12px;
            }
            
            input[type="text"],
            input[type="password"],
            input[type="email"],
            select {
                font-size: 16px;
                padding: 10px !important;
            }
            
            /* Touch-friendly buttons */
            button, .nav-item {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Small landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .grid-container {
                gap: 8px;
            }
            
            .card {
                padding: 10px;
            }
            
            .chart-container {
                height: 150px;
            }
        }
        
        @media (max-width: 600px) {
            .fastfetch-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .ascii-logo {
                display: none; /* Hide ASCII on small screens to save space */
            }
        }
        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.1);
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-cpu);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 24px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()" title="Toggle Menu">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div style="display: flex; align-items: center; margin-bottom: 30px;">
                <div class="sidebar-title">
                    <i class="fas fa-bolt" style="color: var(--accent-cpu);"></i>
                    <span>MONITOR</span>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="nav-item active" onclick="switchPage('general')">
                <i class="fas fa-home" title="General Dashboard"></i>
                <span>General</span>
            </div>
            <div class="nav-item" onclick="switchPage('cpu')">
                <i class="fas fa-microchip" title="CPU Details"></i>
                <span>CPU</span>
            </div>
            <div class="nav-item" onclick="switchPage('gpu')">
                <i class="fas fa-tv" title="GPU Monitor"></i>
                <span>GPU</span>
            </div>
            <div class="nav-item" onclick="switchPage('memory')">
                <i class="fas fa-memory" title="Memory"></i>
                <span>Memory</span>
            </div>
            <div class="nav-item" onclick="switchPage('processes')">
                <i class="fas fa-list" title="Processes"></i>
                <span>Processes</span>
            </div>
            <div class="nav-item" onclick="switchPage('storage')">
                <i class="fas fa-hdd" title="Storage"></i>
                <span>Storage</span>
            </div>
            
            <!-- Network Group -->
            <div class="nav-item" onclick="toggleNetworkSubmenu()">
                <i class="fas fa-network-wired" title="Network"></i>
                <span>Network</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.8rem;" id="net-submenu-icon"></i>
            </div>
            <div id="network-submenu" style="display: none; flex-direction: column; padding-left: 20px; background: rgba(0,0,0,0.2);">
                <div class="nav-item" onclick="switchPage('net-traffic')" style="font-size: 0.9rem;">
                    <i class="fas fa-chart-line"></i>
                    <span>Traffic</span>
                </div>
                <div class="nav-item" onclick="switchPage('ssh')" style="font-size: 0.9rem;">
                    <i class="fas fa-lock"></i>
                    <span>SSH</span>
                </div>
            </div>

            <div class="nav-item" onclick="switchPage('docker')">
                <i class="fab fa-docker" title="Docker Management"></i>
                <span>Docker</span>
            </div>
            <div class="nav-item" onclick="switchPage('services')">
                <i class="fas fa-cogs" title="System Services"></i>
                <span>Services</span>
            </div>
            <div class="nav-item" onclick="switchPage('cron')">
                <i class="fas fa-clock" title="Cron Jobs"></i>
                <span>Cron</span>
            </div>
            
            <div class="nav-item" onclick="switchPage('alerts')">
                <i class="fas fa-bell" title="Alerts"></i>
                <span>Alerts</span>
            </div>

            <div style="margin-top: auto;"></div>

            <!-- Admin Only -->
            <div class="nav-item" id="nav-users" onclick="switchPage('users')" style="display: none;">
                <i class="fas fa-users" title="User Management"></i>
                <span>Users</span>
            </div>
            <div class="nav-item" id="nav-logs" onclick="switchPage('logs')" style="display: none;">
                <i class="fas fa-history" title="Operation Logs"></i>
                <span>Logs</span>
            </div>
            
            <!-- All Users -->
            <div class="nav-item" onclick="switchPage('profile')">
                <i class="fas fa-user-cog" title="Profile"></i>
                <span>Profile</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h1 id="page-title">General Dashboard</h1>
                    <div id="status-dot" class="status-dot" title="Connection Status"></div>
                    <select id="interval-select" onchange="changeInterval()" style="background: rgba(255,255,255,0.1); color: var(--text-main); border: none; padding: 5px; border-radius: 4px; font-family: inherit; font-size: 0.8rem; cursor: pointer;">
                        <option value="2">2s</option>
                        <option value="5" selected>5s</option>
                        <option value="10">10s</option>
                        <option value="20">20s</option>
                        <option value="30">30s</option>
                        <option value="60">60s</option>
                    </select>
                </div>
                <div id="boot-time" class="boot-time">Booting...</div>
            </div>

            <!-- Page: General -->
            <div id="page-general" class="page active">
                <div class="grid-container">
        <!-- System Info (Fastfetch) -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-title">System Information</div>
            <div class="fastfetch-container">
                <div class="sys-info-list" id="sys-info-list">
                    <div>Loading system info...</div>
                </div>
            </div>
        </div>

        <!-- Power Profile Card -->
        <div class="card" id="power-profile-card" style="display: none; grid-column: 1 / -1;">
            <div class="card-title">Power Profile</div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;" id="power-profile-controls">
                <!-- Buttons will be injected here -->
            </div>
        </div>

        <!-- CPU Card -->
        <div class="card">
            <div class="card-title">
                <span>CPU</span>
                <span id="cpu-freq" class="freq-badge">0 MHz</span>
            </div>
            <div class="stat-group">
                <div class="stat-label">
                    <span>Total Load</span>
                    <span id="cpu-total-text">0%</span>
                </div>
                <div class="progress-bg">
                    <div id="cpu-total-bar" class="progress-fill cpu-fill" style="width: 0%"></div>
                </div>
            </div>
            <div id="cpu-cores" class="cpu-grid">
                <!-- Cores injected here -->
            </div>
        </div>

        <!-- Memory Card -->
        <div class="card">
            <div class="card-title">Memory</div>
            <div class="stat-group">
                <div class="stat-label">
                    <span>RAM Usage</span>
                    <span id="mem-text">0 / 0</span>
                </div>
                <div class="progress-bg">
                    <div id="mem-bar" class="progress-fill mem-fill" style="width: 0%"></div>
                </div>
                <div style="text-align: right; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
                    <span id="mem-percent">0%</span>
                </div>
            </div>
            <div id="mem-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                <!-- Details injected here -->
            </div>
            
            <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                <div style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-dim);">Top Processes</div>
                <div id="processes-container" style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto; padding-right: 5px;">
                    <!-- Processes injected here -->
                </div>
            </div>
        </div>

        <!-- Sensors Card -->
        <div class="card">
            <div class="card-title">Sensors & Power</div>
            <div id="sensors-container"></div>
            <div id="power-container" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
        </div>

        <!-- Network Card -->
        <div class="card">
            <div class="card-title">Network</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="net-box">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">UPLOAD SPEED</div>
                    <div id="net-speed-sent" class="net-value" style="color: var(--accent-cpu)">0 B/s</div>
                </div>
                 <div class="net-box">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">DOWNLOAD SPEED</div>
                    <div id="net-speed-recv" class="net-value" style="color: var(--accent-mem)">0 B/s</div>
                </div>
            </div>
        </div>

        <!-- SSH Card -->
        <div class="card">
            <div class="card-title">SSH Status</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <span style="color: var(--text-dim);">Service:</span>
                    <span id="general-ssh-status" style="font-weight: bold; margin-left: 5px;">-</span>
                </div>
                <div>
                    <span style="color: var(--text-dim);">Connections:</span>
                    <span id="general-ssh-connections" style="font-weight: bold; margin-left: 5px; color: var(--accent-net);">0</span>
                </div>
            </div>
            <div style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 5px;">Active Sessions</div>
            <div id="general-ssh-sessions" style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 5px; height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 5px;">
                <!-- Sessions injected here -->
            </div>
        </div>

        <!-- GPU Summary Card (General Page) -->
        <div class="card">
            <div class="card-title">GPU Summary</div>
            <div style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 8px;">
                <span>Name:</span>
                <span id="general-gpu-name" style="font-weight: bold; margin-left: 5px;">-</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                <div>
                    <div style="color: var(--text-dim);">Temp</div>
                    <div id="general-gpu-temp" style="font-weight: bold;">-</div>
                </div>
                <div>
                    <div style="color: var(--text-dim);">Load</div>
                    <div id="general-gpu-load" style="font-weight: bold;">-</div>
                </div>
                <div>
                    <div style="color: var(--text-dim);">Freq</div>
                    <div id="general-gpu-freq" style="font-weight: bold;">-</div>
                </div>
                <div>
                    <div style="color: var(--text-dim);">VRAM</div>
                    <div id="general-gpu-vram" style="font-weight: bold;">-</div>
                </div>
            </div>
            <div id="general-gpu-note" style="margin-top: 8px; font-size: 0.75rem; color: var(--text-dim);"></div>
        </div>

        <!-- Disk Card -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-title">Storage</div>
            <div id="disk-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Disks injected here -->
            </div>
        </div>
    </div> <!-- End grid-container -->
    </div> <!-- End page-general -->

        <!-- Page: Alerts -->
        <div id="page-alerts" class="page">
            <div class="card">
                <div class="card-title">Alert Configuration</div>
                <div style="max-width: 600px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Enable Alerts</label>
                        <label class="switch">
                            <input type="checkbox" id="alert-enabled">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Webhook URL</label>
                        <input type="text" id="alert-webhook" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 4px;" placeholder="https://hooks.slack.com/...">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">CPU Threshold (%)</label>
                        <input type="number" id="alert-cpu" min="0" max="100" style="width: 100px; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Memory Threshold (%)</label>
                        <input type="number" id="alert-mem" min="0" max="100" style="width: 100px; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Disk Threshold (%)</label>
                        <input type="number" id="alert-disk" min="0" max="100" style="width: 100px; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 4px;">
                    </div>
                    <button onclick="saveAlerts()" style="background: var(--accent-cpu); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Save Configuration</button>
                </div>
            </div>
        </div>

    <!-- Other Pages (Placeholders) -->
    <div id="page-cpu" class="page">
        <div class="grid-container">
            <!-- Load Average & Stats -->
            <div class="card">
                <div class="card-title">Load Average & Stats</div>
                <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">1 Min</div>
                        <div id="cpu-load-1" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-cpu);">0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">5 Min</div>
                        <div id="cpu-load-5" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-cpu);">0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">15 Min</div>
                        <div id="cpu-load-15" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-cpu);">0.00</div>
                    </div>
                </div>
                <div class="stat-group">
                    <div class="stat-label">
                        <span>Context Switches</span>
                        <span id="cpu-ctx-switches" style="color: var(--text-main);">0</span>
                    </div>
                    <div class="stat-label">
                        <span>Interrupts</span>
                        <span id="cpu-interrupts" style="color: var(--text-main);">0</span>
                    </div>
                    <div class="stat-label">
                        <span>Syscalls</span>
                        <span id="cpu-syscalls" style="color: var(--text-main);">0</span>
                    </div>
                </div>
            </div>

            <!-- CPU Times Breakdown -->
            <div class="card">
                <div class="card-title">CPU Time Distribution</div>
                <div id="cpu-times-container" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- CPU Information -->
            <div class="card">
                <div class="card-title">CPU Information</div>
                <div id="cpu-info" style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Model:</span>
                        <span id="cpu-model" style="font-weight: 500;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Architecture:</span>
                        <span id="cpu-arch" style="font-weight: 500;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Cores:</span>
                        <span id="cpu-info-cores" style="font-weight: 500;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Threads:</span>
                        <span id="cpu-threads" style="font-weight: 500;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Frequency:</span>
                        <span id="cpu-freq-range" style="font-weight: 500;">-</span>
                    </div>
                </div>
            </div>

            <!-- CPU Temperature Trends -->
            <div class="card">
                <div class="card-title">Temperature Trends (Last 60s)</div>
                <div id="cpu-temp-trend" style="height: 120px; position: relative; display: flex; align-items: flex-end; gap: 2px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <!-- Bar chart injected here -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem;">
                    <span style="color: var(--text-dim);">Average Temp:</span>
                    <span id="cpu-temp-avg" style="font-weight: bold; color: #ff6b6b;">0°C</span>
                </div>
            </div>

            <!-- Detailed Core Grid -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Per Core Usage</div>
                <div id="cpu-detailed-cores" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>
    <div id="page-memory" class="page">
        <div class="grid-container">
            <!-- Memory Usage -->
            <div class="card">
                <div class="card-title">Memory Usage</div>
                <div class="stat-group">
                    <div class="stat-label">
                        <span>RAM Usage</span>
                        <span id="mem-page-text">0 / 0</span>
                    </div>
                    <div class="progress-bg">
                        <div id="mem-page-bar" class="progress-fill mem-fill" style="width: 0%"></div>
                    </div>
                    <div style="text-align: right; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
                        <span id="mem-page-percent">0%</span>
                    </div>
                </div>
                <div id="mem-page-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                    <!-- Details injected here -->
                </div>
            </div>

            <!-- Memory Usage Trends -->
            <div class="card">
                <div class="card-title">Memory Usage Trends (Last 60s)</div>
                <div id="mem-trend" style="height: 120px; position: relative; display: flex; align-items: flex-end; gap: 2px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <!-- Bar chart injected here -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem;">
                    <span style="color: var(--text-dim);">Current Usage:</span>
                    <span id="mem-trend-current" style="font-weight: bold; color: var(--accent-mem);">0%</span>
                </div>
            </div>

            <!-- Swap Usage -->
            <div class="card">
                <div class="card-title">Swap Usage</div>
                <div class="stat-group">
                    <div class="stat-label">
                        <span>Swap</span>
                        <span id="swap-page-text">0 / 0</span>
                    </div>
                    <div class="progress-bg">
                        <div id="swap-page-bar" class="progress-fill disk-fill" style="width: 0%"></div>
                    </div>
                    <div style="text-align: right; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
                        <span id="swap-page-percent">0%</span>
                    </div>
                </div>
            </div>

            <!-- Memory Pie Chart -->
            <div class="card">
                <div class="card-title">Memory Distribution</div>
                <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; padding: 10px;">
                    <svg id="mem-pie-chart" width="180" height="180" style="margin: 0 auto;"></svg>
                    <div id="mem-pie-legend" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; font-size: 0.85rem;">
                        <!-- Legend injected here -->
                    </div>
                </div>
            </div>

            <!-- Process Manager -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>Process Manager</span>
                    <span id="proc-count" style="font-size: 0.8rem; color: var(--text-dim); font-weight: normal;">0 processes</span>
                </div>
                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed;">
                        <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px; width: 80px; color: var(--text-dim); cursor: pointer; font-family: 'JetBrains Mono', monospace;" onclick="setSort('pid')">PID <i class="fas fa-sort"></i></th>
                
                                    <th style="padding: 10px; color: var(--text-dim); cursor: pointer;" onclick="setSort('name')">Name <i class="fas fa-sort"></i></th>
                                    
                                    <th style="padding: 10px; width: 100px; color: var(--text-dim);">User</th>
                                    
                                    <th style="padding: 10px; width: 80px; text-align: right; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">Threads</th>
                                    
                                    <th style="padding: 10px; width: 80px; text-align: right; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">CPU%</th>
                                    
                                    <th style="padding: 10px; width: 80px; text-align: right; color: var(--text-dim); cursor: pointer;font-family: 'JetBrains Mono', monospace;" onclick="setSort('memory_percent')">Mem% <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                    <tbody id="process-table-body">
                </tbody>
                </table>
            </div>
            </div>
        </div>
    </div>
    <div id="page-net-traffic" class="page">
        <div class="grid-container">
            <!-- Global Network Stats -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Global Traffic</div>
                <div class="network-stats">
                    <div class="net-box">
                        <div style="font-size: 0.8rem; color: var(--text-dim);">UPLOAD SPEED</div>
                        <div id="net-page-speed-sent" class="net-value" style="color: var(--accent-cpu)">0 B/s</div>
                    </div>
                    <div class="net-box">
                        <div style="font-size: 0.8rem; color: var(--text-dim);">DOWNLOAD SPEED</div>
                        <div id="net-page-speed-recv" class="net-value" style="color: var(--accent-mem)">0 B/s</div>
                    </div>
                    <div class="net-box">
                        <div style="font-size: 0.8rem; color: var(--text-dim);">TOTAL SENT</div>
                        <div id="net-page-sent" class="net-value">0 B</div>
                    </div>
                    <div class="net-box">
                        <div style="font-size: 0.8rem; color: var(--text-dim);">TOTAL RECV</div>
                        <div id="net-page-recv" class="net-value">0 B</div>
                    </div>
                </div>
            </div>

            <!-- Connection State Details -->
            <div class="card">
                <div class="card-title">TCP Connection States</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85rem;">
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">ESTABLISHED</span>
                        <span id="tcp-established" style="font-weight: bold; color: var(--accent-cpu);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">TIME_WAIT</span>
                        <span id="tcp-time-wait" style="font-weight: bold; color: var(--text-dim);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">CLOSE_WAIT</span>
                        <span id="tcp-close-wait" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">LISTEN</span>
                        <span id="tcp-listen" style="font-weight: bold; color: var(--accent-mem);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">SYN_SENT</span>
                        <span id="tcp-syn-sent" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">SYN_RECV</span>
                        <span id="tcp-syn-recv" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">FIN_WAIT1</span>
                        <span id="tcp-fin-wait1" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">FIN_WAIT2</span>
                        <span id="tcp-fin-wait2" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px; background: var(--card-bg); border-radius: 4px;">
                        <span style="color: var(--text-dim);">LAST_ACK</span>
                        <span id="tcp-last-ack" style="font-weight: bold;">0</span>
                    </div>
                </div>
            </div>

            <!-- Protocol Stats -->
            <div class="card">
                <div class="card-title">Active Connections</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">TCP</div>
                        <div id="net-tcp-count" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-cpu);">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">UDP</div>
                        <div id="net-udp-count" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-mem);">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">TCP TimeWait</div>
                        <div id="net-tcp-tw" style="font-size: 1.5rem; font-weight: bold; color: var(--text-dim);">0</div>
                    </div>
                </div>
            </div>

            <!-- Listening Ports -->
            <div class="card">
                <div class="card-title">Listening Ports</div>
                <div id="listening-ports" style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 5px; max-height: 250px; overflow-y: auto;">
                    <!-- Ports injected here -->
                </div>
            </div>

            <!-- Network Errors & Packet Loss -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Network Errors & Packet Loss</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">ERRORS IN</div>
                        <div id="net-errors-in" style="font-size: 1.3rem; font-weight: bold; color: #ff6b6b;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">ERRORS OUT</div>
                        <div id="net-errors-out" style="font-size: 1.3rem; font-weight: bold; color: #ff6b6b;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">DROPS IN</div>
                        <div id="net-drops-in" style="font-size: 1.3rem; font-weight: bold; color: #ffa94d;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">DROPS OUT</div>
                        <div id="net-drops-out" style="font-size: 1.3rem; font-weight: bold; color: #ffa94d;">0</div>
                    </div>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 10px;">Per-Interface Statistics</div>
                <div id="net-error-details" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 10px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Interfaces Grid -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Interfaces</div>
                <div id="net-interfaces" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>
    <div id="page-storage" class="page">
        <div class="grid-container">
            <!-- Disk Overview -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Disk Overview</div>
                <div id="disk-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Partitions List -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Partitions & Mount Points</div>
                <div id="storage-partitions" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Inode Usage -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Inode Usage</div>
                <div id="inode-usage" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Disk I/O Statistics -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Disk I/O</div>
                <div id="disk-io-stats" style="display: flex; flex-direction: column; gap: 10px; max-height: 600px; overflow-y: auto;">
                    <!-- Injected via JS --></div>
            </div>
        </div>
    </div>

    <!-- SSH Page -->
    <div id="page-ssh" class="page">
        <div class="grid-container">
            <!-- SSH Status Cards -->
            <div class="card" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-memory);">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">SSH Port Status</div>
                    <div id="ssh-status" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-memory);">-</div>
                </div>
                <div style="background: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-network);">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">Active Connections</div>
                    <div id="ssh-connections" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-network);">0</div>
                </div>
                <div style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-disk);">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">SSH Process Memory</div>
                    <div id="ssh-memory" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-disk);">-</div>
                </div>
                <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #FF6B6B;">
                    <div style="font-size: 0.8rem; color: var(--text-dim);">Failed Logins</div>
                    <div id="ssh-failed-logins" style="font-size: 1.5rem; font-weight: bold; color: #FF6B6B;">0</div>
                </div>
            </div>

            <!-- SSH Active Sessions -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Active SSH Sessions</div>
                <div id="ssh-sessions" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">No active sessions</div>
                </div>
            </div>

            <!-- SSH Authentication Methods -->
            <div class="card">
                <div class="card-title">Auth Methods</div>
                <div id="ssh-auth-methods" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- SSH Host Key Fingerprint -->
            <div class="card">
                <div class="card-title">Host Key Fingerprint (RSA)</div>
                <div style="font-size: 0.85rem; word-break: break-all; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; font-family: monospace; line-height: 1.4; max-height: 150px; overflow-y: auto;">
                    <div id="ssh-hostkey" style="color: var(--text-main);">-</div>
                </div>
            </div>

            <!-- SSH Session History -->
            <div class="card">
                <div class="card-title">Known Hosts</div>
                <div style="font-size: 0.9rem; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <div id="ssh-history" style="color: var(--text-main);">-</div>
                </div>
            </div>

            <!-- OOM Risk Processes -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">High Memory Processes (OOM Risk Monitoring)</div>
                <div id="ssh-oom-processes" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">All processes within safe memory range</div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-gpu" class="page">
        <div class="grid-container">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">GPU Monitor</div>
                <div id="gpu-grid" class="gpu-grid">
                    <!-- GPU cards injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <div id="page-processes" class="page">
        <div class="grid-container">
            <!-- 统计面板 -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Process Statistics</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Total Processes</div>
                        <div id="proc-total" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-cpu);">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Total Threads</div>
                        <div id="proc-threads" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-mem);">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Avg CPU %</div>
                        <div id="proc-avg-cpu" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-net);">0%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Avg Memory %</div>
                        <div id="proc-avg-mem" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-disk);">0%</div>
                    </div>
                </div>
            </div>

            <!-- 搜索和排序 -->
            <div class="card" style="grid-column: 1 / -1;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="proc-search" placeholder="Search process..." 
                           style="flex: 1; min-width: 200px; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: var(--text-main); font-family: inherit;"
                           onkeyup="filterAndRenderProcesses()">
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="sort-btn active" onclick="setProcessSort('memory')" title="Sort by Memory">
                            <i class="fas fa-sort-amount-down-alt"></i> Memory
                        </button>
                        <button class="sort-btn" onclick="setProcessSort('cpu')" title="Sort by CPU">
                            <i class="fas fa-microchip"></i> CPU
                        </button>
                        <button class="sort-btn" onclick="setProcessSort('threads')" title="Sort by Threads">
                            <i class="fas fa-sitemap"></i> Threads
                        </button>
                        <button class="sort-btn" onclick="setProcessSort('uptime')" title="Sort by Uptime">
                            <i class="fas fa-hourglass-start"></i> Uptime
                        </button>
                        <button class="sort-btn" onclick="setProcessSort('tree')" title="Process Tree">
                            <i class="fas fa-tree"></i> Tree
                        </button>
                    </div>
                </div>
            </div>

            <!-- 进程列表 -->
            <div class="card" style="grid-column: 1 / -1; max-height: 600px; overflow-y: auto;">
                <div id="process-container" style="font-size: 0.9rem;">
                    <!-- 进程列表将注入这里 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 进程详情模态框 -->
    <div id="proc-detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
        <div style="background: var(--card-bg); margin: 50px auto; max-width: 700px; border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                <h2 id="proc-detail-name" style="margin: 0; color: var(--accent-cpu);">Process Name</h2>
                <button onclick="closeProcDetail()" style="background: none; border: none; color: var(--text-main); cursor: pointer; font-size: 1.5rem;">×</button>
            </div>
            <div id="proc-detail-content" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- 详情内容将注入这里 -->
            </div>
        </div>
    </div>

    <!-- Docker Page -->
    <div id="page-docker" class="page">
        <div class="grid-container">
            <!-- Containers -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>Docker Containers</span>
                    <button onclick="loadDockerContainers()" style="background: none; border: none; color: var(--text-dim); cursor: pointer;"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                    <input type="text" id="docker-container-search" placeholder="Search containers..." onkeyup="renderDockerContainers()" style="padding: 5px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main); font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px; cursor: pointer;" onclick="setDockerContainerSort('name')">Name <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px;">Image</th>
                                <th style="padding: 10px; cursor: pointer;" onclick="setDockerContainerSort('state')">State <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px;">Status</th>
                                <th style="padding: 10px;">Ports</th>
                                <th style="padding: 10px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="docker-containers-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Images -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>Docker Images</span>
                    <button onclick="loadDockerImages()" style="background: none; border: none; color: var(--text-dim); cursor: pointer;"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                    <input type="text" id="docker-image-search" placeholder="Search images..." onkeyup="renderDockerImages()" style="padding: 5px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main); font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px; cursor: pointer;" onclick="setDockerImageSort('id')">ID <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px;">Tags</th>
                                <th style="padding: 10px; cursor: pointer;" onclick="setDockerImageSort('size')">Size <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px; cursor: pointer;" onclick="setDockerImageSort('created')">Created <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="docker-images-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Services Page -->
    <div id="page-services" class="page">
        <div class="grid-container">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>System Services</span>
                    <button onclick="loadServices()" style="background: none; border: none; color: var(--text-dim); cursor: pointer;"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                    <input type="text" id="service-search" placeholder="Search services..." onkeyup="renderServices()" style="padding: 5px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main); font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px; cursor: pointer;" onclick="setServiceSort('unit')">Unit <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px;">Load</th>
                                <th style="padding: 10px; cursor: pointer;" onclick="setServiceSort('active')">Active <i class="fas fa-sort"></i></th>
                                <th style="padding: 10px;">Sub</th>
                                <th style="padding: 10px;">Description</th>
                                <th style="padding: 10px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="services-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Cron Jobs Page -->
    <div id="page-cron" class="page">
        <div class="grid-container">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>Cron Jobs (Root)</span>
                    <div>
                        <button id="btn-add-cron" onclick="addCronJob()" style="background: var(--accent-mem); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none;"><i class="fas fa-plus"></i> Add Job</button>
                        <button id="btn-save-cron" onclick="saveCronJobs()" style="background: var(--accent-net); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; display: none;"><i class="fas fa-save"></i> Save Changes</button>
                        <button onclick="loadCronJobs()" style="background: none; border: none; color: var(--text-dim); cursor: pointer; margin-left: 10px;"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main); font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px; width: 20%;">Schedule</th>
                                <th style="padding: 10px; width: 70%;">Command</th>
                                <th style="padding: 10px; width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cron-body"></tbody>
                    </table>
                </div>
                <div style="margin-top: 10px; color: var(--text-dim); font-size: 0.8rem;">
                    <i class="fas fa-info-circle"></i> Schedule format: Minute Hour Day Month Weekday (e.g., "*/5 * * * *" for every 5 mins)
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Page -->
    <div id="page-users" class="page">
        <div class="grid-container">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">
                    <span>User Management</span>
                    <button onclick="showAddUserModal()" style="background: var(--accent-mem); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main);">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px;">Username</th>
                                <th style="padding: 10px;">Role</th>
                                <th style="padding: 10px;">Created At</th>
                                <th style="padding: 10px;">Last Login</th>
                                <th style="padding: 10px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Operation Logs Page -->
    <div id="page-logs" class="page">
        <div class="grid-container">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title">Operation Logs</div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-main);">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 10px;">Time</th>
                                <th style="padding: 10px;">User</th>
                                <th style="padding: 10px;">Action</th>
                                <th style="padding: 10px;">Details</th>
                                <th style="padding: 10px;">IP</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <!-- Logs injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="page-profile" class="page">
        <div class="grid-container" style="display: flex; justify-content: center;">
            <div class="card" style="width: 100%; max-width: 600px;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--accent-cpu);">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;" id="profile-username">-</div>
                        <div style="color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 15px; display: inline-block; font-size: 0.85rem;">
                            <i class="fas fa-shield-alt" style="margin-right: 5px;"></i> <span id="profile-role">-</span>
                        </div>
                    </div>
                </div>

                <div class="card-title"><i class="fas fa-key" style="margin-right: 10px;"></i> Change Password</div>
                <form id="change-password-form" onsubmit="handleChangePassword(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-dim); font-size: 0.9rem;">Current Password</label>
                        <div style="position: relative;">
                            <i class="fas fa-lock" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                            <input type="password" id="cp-old" required style="width: 100%; padding: 12px 12px 12px 35px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 6px; font-family: inherit; box-sizing: border-box; transition: border-color 0.2s;">
                        </div>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-dim); font-size: 0.9rem;">New Password</label>
                        <div style="position: relative;">
                            <i class="fas fa-lock" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                            <input type="password" id="cp-new" required style="width: 100%; padding: 12px 12px 12px 35px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 6px; font-family: inherit; box-sizing: border-box; transition: border-color 0.2s;">
                        </div>
                    </div>
                    <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(45deg, var(--accent-cpu), #ff6b81); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: opacity 0.2s;">
                        Update Password
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="width: 400px; background: #2d2d2d;">
            <div class="card-title">
                <span>Add New User</span>
                <i class="fas fa-times" onclick="document.getElementById('add-user-modal').style.display='none'" style="cursor: pointer;"></i>
            </div>
            <form onsubmit="handleAddUser(event)">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Username</label>
                    <input type="text" id="new-username" required style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Password</label>
                    <input type="password" id="new-password" required style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Role</label>
                    <select id="new-role" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" style="width: 100%; padding: 10px; background: var(--accent-mem); border: none; color: white; border-radius: 4px; cursor: pointer;">Create User</button>
            </form>
        </div>
    </div>

    </div> <!-- End main-content -->
</div> <!-- End app-container -->

    <script>
        // === MOBILE MENU TOGGLE ===
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.toggle('mobile-open');
            mobileBtn.classList.toggle('active');
        }

        // Close mobile menu when a page is selected
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.getElementById('mobile-menu-btn');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('mobile-open');
                mobileBtn.classList.remove('active');
            }
        }

        // 侧边栏切换函数
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebar-toggle');
            sidebar.classList.toggle('collapsed');
            
            // 保存状态到本地存储
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            
            // 更新按钮图标
            if (isCollapsed) {
                toggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
            } else {
                toggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
            }
        }

        // 页面加载时恢复侧边栏状态
        window.addEventListener('DOMContentLoaded', function() {
            checkRole();
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('collapsed');
                const toggle = document.getElementById('sidebar-toggle');
                toggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }

            // Close mobile menu on window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeMobileMenu();
                }
            });
        });

        function toggleNetworkSubmenu() {
            const submenu = document.getElementById('network-submenu');
            const icon = document.getElementById('net-submenu-icon');
            if (submenu.style.display === 'none') {
                submenu.style.display = 'flex';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                submenu.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function switchPage(pageId) {
            // Close mobile menu when switching pages
            closeMobileMenu();
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            // Show selected page
            document.getElementById('page-' + pageId).classList.add('active');
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Find the nav item that corresponds to the page
            const navItem = document.querySelector(`.nav-item[onclick*="'${pageId}'"]`);
            if (navItem) {
                navItem.classList.add('active');
                // If it's a submenu item, keep parent active too (optional, but good for UX)
                // For now, just ensure the submenu is open if we are navigating to a child
                if (['net-traffic', 'ssh'].includes(pageId)) {
                    document.getElementById('network-submenu').style.display = 'flex';
                    document.getElementById('net-submenu-icon').classList.remove('fa-chevron-down');
                    document.getElementById('net-submenu-icon').classList.add('fa-chevron-up');
                }
            }
            
            // Update title
            const titles = {
                'general': 'General Dashboard',
                'cpu': 'CPU Analysis',
                'memory': 'Memory Analysis',
                'processes': 'Process Manager',
                'storage': 'Storage Manager',
                'net-traffic': 'Network Traffic',
                'gpu': 'GPU Monitor',
                'docker': 'Docker Management',
                'services': 'System Services',
                'ssh': 'SSH Monitor',
                'cron': 'Cron Jobs',
                'users': 'User Management',
                'logs': 'Operation Logs',
                'profile': 'My Profile'
            };
            if (titles[pageId]) {
                document.getElementById('page-title').innerText = titles[pageId];
            }
            
            // Initialize GPU charts if switching to GPU page
            if (pageId === 'gpu' && lastData && lastData.gpu) {
                requestAnimationFrame(() => renderGPUs(lastData.gpu));
            }
            
            // Initialize Network Traffic charts if switching to Traffic page
            if (pageId === 'net-traffic') {
                // Ensure charts are resized/rendered if needed
                // (Chart.js usually handles this, but good to know)
            }

            // Network Diagnostics 页面已移除，无需额外权限处理

            // Load data for specific pages
            if (pageId === 'docker') { loadDockerContainers(); loadDockerImages(); }
            if (pageId === 'services') loadServices();
            if (pageId === 'cron') loadCronJobs();
            if (pageId === 'users') loadUsers();
            if (pageId === 'logs') loadLogs();
            if (pageId === 'profile') loadProfile();
        }

        // Global data storage for filtering/sorting
        let allDockerContainers = [];
        let allDockerImages = [];
        let allServices = [];

        let dockerContainerSort = { column: 'name', direction: 'asc' };
        let dockerImageSort = { column: 'created', direction: 'desc' };
        let serviceSort = { column: 'unit', direction: 'asc' };

        // Docker Functions
        async function loadDockerContainers() {
            try {
                const response = await fetch('/api/docker/containers');
                if (response.ok) {
                    const data = await response.json();
                    allDockerContainers = data.containers || [];
                    renderDockerContainers();
                }
            } catch (err) {
                console.error('Failed to load containers', err);
            }
        }

        function renderDockerContainers() {
            const tbody = document.getElementById('docker-containers-body');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('docker-container-search').value.toLowerCase();
            
            let filtered = allDockerContainers.filter(c => {
                const name = c.Names ? c.Names[0].replace('/', '') : c.Id.substring(0, 12);
                return name.toLowerCase().includes(searchTerm) || 
                       (c.Image && c.Image.toLowerCase().includes(searchTerm)) ||
                       (c.State && c.State.toLowerCase().includes(searchTerm));
            });

            // Sort
            filtered.sort((a, b) => {
                let valA, valB;
                if (dockerContainerSort.column === 'name') {
                    valA = a.Names ? a.Names[0].replace('/', '') : a.Id;
                    valB = b.Names ? b.Names[0].replace('/', '') : b.Id;
                } else if (dockerContainerSort.column === 'state') {
                    valA = a.State;
                    valB = b.State;
                } else {
                    return 0;
                }
                
                if (valA < valB) return dockerContainerSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return dockerContainerSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 10px; text-align: center; color: var(--text-dim);">No containers found</td></tr>';
                return;
            }

            const role = localStorage.getItem('role');

            filtered.forEach(c => {
                const name = c.Names ? c.Names[0].replace('/', '') : c.Id.substring(0, 12);
                const ports = c.Ports ? c.Ports.map(p => `${p.PrivatePort}->${p.PublicPort}/${p.Type}`).join(', ') : '';
                const stateColor = c.State === 'running' ? 'var(--accent-mem)' : 'var(--text-dim)';
                
                let actionsHtml = '';
                if (role === 'admin') {
                    actionsHtml = c.State === 'running' ? 
                        `<button onclick="handleDockerAction('${c.Id}', 'stop')" style="background: #ff6b6b; border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Stop</button>
                         <button onclick="handleDockerAction('${c.Id}', 'restart')" style="background: var(--accent-net); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Restart</button>` : 
                        `<button onclick="handleDockerAction('${c.Id}', 'start')" style="background: var(--accent-mem); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Start</button>
                         <button onclick="handleDockerAction('${c.Id}', 'remove')" style="background: var(--text-dim); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Remove</button>`;
                } else {
                    actionsHtml = '<span style="color: var(--text-dim); font-size: 0.8rem;">Read-only</span>';
                }

                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                tr.innerHTML = `
                    <td style="padding: 10px; font-weight: bold;">${name}</td>
                    <td style="padding: 10px; color: var(--text-dim);">${c.Image}</td>
                    <td style="padding: 10px;"><span style="color: ${stateColor}">${c.State}</span></td>
                    <td style="padding: 10px; font-size: 0.85rem;">${c.Status}</td>
                    <td style="padding: 10px; font-size: 0.85rem;">${ports}</td>
                    <td style="padding: 10px;">
                        ${actionsHtml}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setDockerContainerSort(column) {
            if (dockerContainerSort.column === column) {
                dockerContainerSort.direction = dockerContainerSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                dockerContainerSort.column = column;
                dockerContainerSort.direction = 'asc';
            }
            renderDockerContainers();
        }

        async function loadDockerImages() {
            try {
                const response = await fetch('/api/docker/images');
                if (response.ok) {
                    const data = await response.json();
                    allDockerImages = data.images || [];
                    renderDockerImages();
                }
            } catch (err) {
                console.error('Failed to load images', err);
            }
        }

        function renderDockerImages() {
            const tbody = document.getElementById('docker-images-body');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('docker-image-search').value.toLowerCase();
            
            let filtered = allDockerImages.filter(img => {
                const id = img.Id.substring(7, 19);
                return id.toLowerCase().includes(searchTerm) ||
                       (img.RepoTags && img.RepoTags.some(t => t.toLowerCase().includes(searchTerm)));
            });

            // Sort
            filtered.sort((a, b) => {
                let valA, valB;
                if (dockerImageSort.column === 'id') {
                    valA = a.Id;
                    valB = b.Id;
                } else if (dockerImageSort.column === 'size') {
                    valA = a.Size;
                    valB = b.Size;
                } else if (dockerImageSort.column === 'created') {
                    valA = a.Created;
                    valB = b.Created;
                } else {
                    return 0;
                }
                
                if (valA < valB) return dockerImageSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return dockerImageSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 10px; text-align: center; color: var(--text-dim);">No images found</td></tr>';
                return;
            }

            filtered.forEach(img => {
                const id = img.Id.substring(7, 19); // sha256:xxxxxxxx...
                const size = (img.Size / 1024 / 1024).toFixed(2) + ' MB';
                const created = new Date(img.Created * 1000).toLocaleDateString();
                const tags = img.RepoTags ? img.RepoTags.join(', ') : '<none>';
                
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                tr.innerHTML = `
                    <td style="padding: 10px; font-family: monospace;">${id}</td>
                    <td style="padding: 10px;">${tags}</td>
                    <td style="padding: 10px;">${size}</td>
                    <td style="padding: 10px;">${created}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setDockerImageSort(column) {
            if (dockerImageSort.column === column) {
                dockerImageSort.direction = dockerImageSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                dockerImageSort.column = column;
                dockerImageSort.direction = 'asc'; // Default to asc, but for size/created desc might be better initially? Logic keeps it simple.
                if (column === 'size' || column === 'created') dockerImageSort.direction = 'desc';
            }
            renderDockerImages();
        }

        async function handleDockerAction(id, action) {
            if (!confirm(`Are you sure you want to ${action} this container?`)) return;
            try {
                const response = await fetch('/api/docker/action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, action})
                });
                if (response.ok) {
                    loadDockerContainers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Action failed'));
                }
            } catch (err) {
                alert('Failed to perform action');
            }
        }

        // Systemd Service Functions
        async function loadServices() {
            const tbody = document.getElementById('services-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Loading...</td></tr>';

            try {
                const response = await fetch('/api/systemd/services');
                if (!response.ok) throw new Error('Failed to fetch services');
                const services = await response.json();
                allServices = services || [];
                renderServices();
            } catch (err) {
                console.error('Failed to load services', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: #ff4757;">Failed to load services</td></tr>';
            }
        }

        function renderServices() {
            const tbody = document.getElementById('services-body');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('service-search').value.toLowerCase();
            
            let filtered = allServices.filter(svc => {
                return svc.unit.toLowerCase().includes(searchTerm) ||
                       (svc.description && svc.description.toLowerCase().includes(searchTerm));
            });

            // Sort
            filtered.sort((a, b) => {
                let valA, valB;
                if (serviceSort.column === 'unit') {
                    valA = a.unit;
                    valB = b.unit;
                } else if (serviceSort.column === 'active') {
                    valA = a.active;
                    valB = b.active;
                } else {
                    return 0;
                }
                
                if (valA < valB) return serviceSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return serviceSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">No services found</td></tr>';
                return;
            }

            const role = localStorage.getItem('role');

            filtered.forEach(svc => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                
                // Determine status color
                let statusColor = '#888';
                if (svc.active === 'active') statusColor = '#2ed573';
                else if (svc.active === 'failed') statusColor = '#ff4757';

                // Actions
                let actionsHtml = '';
                if (role === 'admin') {
                    const btnStyle = "border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;";
                    if (svc.active === 'active') {
                        actionsHtml += `<button onclick="handleServiceAction('${svc.unit}', 'stop')" style="${btnStyle} background: #ff6b6b;">Stop</button>`;
                        actionsHtml += `<button onclick="handleServiceAction('${svc.unit}', 'restart')" style="${btnStyle} background: var(--accent-net);">Restart</button>`;
                    } else {
                        actionsHtml += `<button onclick="handleServiceAction('${svc.unit}', 'start')" style="${btnStyle} background: var(--accent-mem);">Start</button>`;
                    }
                } else {
                    actionsHtml = '<span style="color: var(--text-dim); font-size: 0.8rem;">Read-only</span>';
                }

                tr.innerHTML = `
                    <td style="padding: 10px; font-weight: bold;">${svc.unit}</td>
                    <td style="padding: 10px;">${svc.load}</td>
                    <td style="padding: 10px;"><span style="color: ${statusColor}">${svc.active}</span></td>
                    <td style="padding: 10px;">${svc.sub}</td>
                    <td style="padding: 10px; color: var(--text-dim); font-size: 0.85rem;">${svc.description}</td>
                    <td style="padding: 10px;">${actionsHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setServiceSort(column) {
            if (serviceSort.column === column) {
                serviceSort.direction = serviceSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                serviceSort.column = column;
                serviceSort.direction = 'asc';
            }
            renderServices();
        }

        async function handleServiceAction(unit, action) {
            if (!confirm(`Are you sure you want to ${action} service ${unit}?`)) return;

            try {
                const response = await fetch('/api/systemd/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ unit, action })
                });

                if (!response.ok) {
                    const data = await response.json(); // Try to parse JSON error
                    throw new Error(data.error || 'Action failed');
                }

                loadServices();
            } catch (error) {
                console.error('Error performing action:', error);
                // If JSON parse failed, it might be text
                alert(`Failed to ${action} service: ${error.message || error}`);
            }
        }

        // Cron Job Functions
        let currentCronJobs = [];

        async function loadCronJobs() {
            const tbody = document.getElementById('cron-body');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">Loading...</td></tr>';
            
            try {
                const response = await fetch('/api/cron');
                if (!response.ok) throw new Error('Failed to fetch cron jobs');
                currentCronJobs = await response.json();
                
                renderCronJobs();
                
                // Show/Hide buttons based on role
                const role = localStorage.getItem('role');
                if (role === 'admin') {
                    document.getElementById('btn-add-cron').style.display = 'inline-block';
                    document.getElementById('btn-save-cron').style.display = 'inline-block';
                } else {
                    document.getElementById('btn-add-cron').style.display = 'none';
                    document.getElementById('btn-save-cron').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading cron jobs:', error);
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color: #ff4757; padding: 20px;">Error: ${error.message}</td></tr>`;
            }
        }

        function renderCronJobs() {
            const tbody = document.getElementById('cron-body');
            tbody.innerHTML = '';
            
            if (!currentCronJobs || currentCronJobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px; color: var(--text-dim);">No cron jobs found</td></tr>';
                return;
            }

            const role = localStorage.getItem('role');
            
            currentCronJobs.forEach((job, index) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                
                let actionsHtml = '';
                if (role === 'admin') {
                    actionsHtml = `<button onclick="deleteCronJob(${index})" style="background: #ff6b6b; border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Delete</button>`;
                } else {
                    actionsHtml = '<span style="color: var(--text-dim); font-size: 0.8rem;">Read-only</span>';
                }

                // Editable fields for admin
                const scheduleHtml = role === 'admin' 
                    ? `<input type="text" value="${job.schedule}" onchange="updateCronJob(${index}, 'schedule', this.value)" style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); padding: 4px; width: 100%; font-family: monospace;">`
                    : `<span style="font-family: monospace;">${job.schedule}</span>`;
                
                const commandHtml = role === 'admin'
                    ? `<input type="text" value="${job.command}" onchange="updateCronJob(${index}, 'command', this.value)" style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); padding: 4px; width: 100%; font-family: monospace;">`
                    : `<span style="font-family: monospace;">${job.command}</span>`;

                tr.innerHTML = `
                    <td style="padding: 10px;">${scheduleHtml}</td>
                    <td style="padding: 10px;">${commandHtml}</td>
                    <td style="padding: 10px;">${actionsHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addCronJob() {
            currentCronJobs.push({ schedule: '* * * * *', command: 'echo "New Job"' });
            renderCronJobs();
        }

        function deleteCronJob(index) {
            if (confirm('Delete this job?')) {
                currentCronJobs.splice(index, 1);
                renderCronJobs();
            }
        }

        function updateCronJob(index, field, value) {
            currentCronJobs[index][field] = value;
        }

        async function saveCronJobs() {
            if (!confirm('Save changes to crontab? This will overwrite the current crontab.')) return;
            
            try {
                const response = await fetch('/api/cron', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentCronJobs)
                });
                
                if (response.ok) {
                    alert('Crontab saved successfully!');
                    loadCronJobs();
                } else {
                    const data = await response.json();
                    alert('Error saving crontab: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save crontab: ' + error.message);
            }
        }

        // Network Tools Functions
        let currentNetTool = 'ping';

        // Network Diagnostics 功能已移除

        // User Management Functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = '';
                    data.users.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        tr.innerHTML = `
                            <td style="padding: 10px;">${user.username}</td>
                            <td style="padding: 10px;"><span style="background: ${user.role === 'admin' ? 'var(--accent-cpu)' : 'var(--accent-net)'}; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${user.role}</span></td>
                            <td style="padding: 10px;">${new Date(user.created_at).toLocaleString()}</td>
                            <td style="padding: 10px;">${user.last_login ? new Date(user.last_login).toLocaleString() : '-'}</td>
                            <td style="padding: 10px;">
                                ${user.username !== 'admin' ? `<button onclick="handleDeleteUser('${user.username}')" style="background: var(--accent-cpu); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Delete</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (err) {
                console.error('Failed to load users', err);
            }
        }

        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'flex';
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, role})
                });
                if (response.ok) {
                    document.getElementById('add-user-modal').style.display = 'none';
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    loadUsers();
                    alert('User created successfully');
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Failed to create user');
            }
        }

        async function handleDeleteUser(username) {
            if (!confirm(`Are you sure you want to delete user ${username}?`)) return;
            
            try {
                const response = await fetch(`/api/users?username=${username}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    loadUsers();
                } else {
                    alert('Failed to delete user');
                }
            } catch (err) {
                alert('Error deleting user');
            }
        }

        // Logs Functions
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('logs-table-body');
                    tbody.innerHTML = '';
                    data.logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        tr.innerHTML = `
                            <td style="padding: 10px; font-size: 0.9rem;">${new Date(log.time).toLocaleString()}</td>
                            <td style="padding: 10px;">${log.username}</td>
                            <td style="padding: 10px;">${log.action}</td>
                            <td style="padding: 10px; color: var(--text-dim);">${log.details}</td>
                            <td style="padding: 10px; font-size: 0.9rem;">${log.ip_address}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (err) {
                console.error('Failed to load logs', err);
            }
        }

        // Profile Functions
        function loadProfile() {
            const username = localStorage.getItem('username') || '-';
            const role = localStorage.getItem('role') || '-';
            
            document.getElementById('profile-username').innerText = username;
            document.getElementById('profile-role').innerText = role;
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('cp-old').value;
            const newPassword = document.getElementById('cp-new').value;
            
            try {
                const response = await fetch('/api/password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({old_password: oldPassword, new_password: newPassword})
                });
                
                if (response.ok) {
                    alert('Password changed successfully');
                    document.getElementById('change-password-form').reset();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to change password'));
                }
            } catch (err) {
                alert('Error changing password');
            }
        }
        
        // Check Role on Load
        function checkRole() {
            const role = localStorage.getItem('role');
            if (role === 'admin') {
                document.getElementById('nav-users').style.display = 'flex';
                document.getElementById('nav-logs').style.display = 'flex';
            }
            loadPowerProfile();
            loadAlerts();
        }

        function loadPowerProfile() {
            fetch('/api/power/profile', {
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.error || !data.available || data.available.length === 0) {
                    return; // Not supported
                }

                const card = document.getElementById('power-profile-card');
                const container = document.getElementById('power-profile-controls');
                card.style.display = 'block';
                container.innerHTML = '';

                const role = localStorage.getItem('role');
                const isAdmin = role === 'admin';

                data.available.forEach(profile => {
                    const btn = document.createElement('button');
                    btn.innerText = profile;
                    btn.style.padding = '8px 16px';
                    btn.style.borderRadius = '4px';
                    btn.style.border = '1px solid rgba(255,255,255,0.2)';
                    btn.style.cursor = isAdmin ? 'pointer' : 'default';
                    btn.style.textTransform = 'capitalize';
                    btn.style.fontWeight = 'bold';
                    btn.style.transition = 'all 0.2s';

                    if (profile === data.current) {
                        btn.style.background = 'var(--accent-cpu)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--accent-cpu)';
                    } else {
                        btn.style.background = 'rgba(255,255,255,0.05)';
                        btn.style.color = 'var(--text-dim)';
                    }

                    if (isAdmin) {
                        btn.onclick = () => setPowerProfile(profile);
                        btn.onmouseover = () => {
                            if (profile !== data.current) {
                                btn.style.background = 'rgba(255,255,255,0.1)';
                                btn.style.color = 'var(--text-main)';
                            }
                        };
                        btn.onmouseout = () => {
                            if (profile !== data.current) {
                                btn.style.background = 'rgba(255,255,255,0.05)';
                                btn.style.color = 'var(--text-dim)';
                            }
                        };
                    } else {
                        btn.disabled = true;
                        btn.style.opacity = profile === data.current ? '1' : '0.5';
                    }

                    container.appendChild(btn);
                });
            })
            .catch(err => console.error('Failed to load power profile:', err));
        }

        function setPowerProfile(profile) {
            fetch('/api/power/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ profile: profile })
            })
            .then(res => {
                if (res.ok) {
                    loadPowerProfile(); // Refresh UI
                } else {
                    alert('Failed to set power profile');
                }
            })
            .catch(err => console.error('Error setting profile:', err));
        }

        function loadAlerts() {
            fetch('/api/alerts', {
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('alert-enabled').checked = data.enabled;
                document.getElementById('alert-webhook').value = data.webhook_url || '';
                document.getElementById('alert-cpu').value = data.cpu_threshold || 90;
                document.getElementById('alert-mem').value = data.mem_threshold || 90;
                document.getElementById('alert-disk').value = data.disk_threshold || 90;
            })
            .catch(err => console.error('Failed to load alerts:', err));
        }

        function saveAlerts() {
            const config = {
                enabled: document.getElementById('alert-enabled').checked,
                webhook_url: document.getElementById('alert-webhook').value,
                cpu_threshold: parseFloat(document.getElementById('alert-cpu').value),
                mem_threshold: parseFloat(document.getElementById('alert-mem').value),
                disk_threshold: parseFloat(document.getElementById('alert-disk').value)
            };

            fetch('/api/alerts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(config)
            })
            .then(res => {
                if (res.ok) {
                    alert('Alert configuration saved');
                } else {
                    alert('Failed to save alert configuration');
                }
            })
            .catch(err => console.error('Error saving alerts:', err));
        }

        // Fetch static info once
        fetch('/api/info')
            .then(response => response.json())
            .then(data => {
                const infoList = document.getElementById('sys-info-list');
                infoList.innerHTML = `
                    <div style="color: var(--accent-cpu); font-weight: bold; margin-bottom: 5px;">${data.header}</div>
                    <div style="color: var(--text-dim); margin-bottom: 10px;">--------------------------</div>
                    <div><span class="sys-key">OS:</span><span class="sys-val">${data.os}</span></div>
                    <div><span class="sys-key">Kernel:</span><span class="sys-val">${data.kernel}</span></div>
                    <div><span class="sys-key">Uptime:</span><span class="sys-val">${data.uptime}</span></div>
                    <div><span class="sys-key">Shell:</span><span class="sys-val">${data.shell}</span></div>
                    <div><span class="sys-key">CPU:</span><span class="sys-val">${data.cpu}</span></div>
                    <div><span class="sys-key">GPU:</span><span class="sys-val">${data.gpu}</span></div>
                    <div><span class="sys-key">Memory:</span><span class="sys-val">${data.memory}</span></div>
                    <div><span class="sys-key">Swap:</span><span class="sys-val">${data.swap}</span></div>
                    <div><span class="sys-key">Disk (/):</span><span class="sys-val">${data.disk}</span></div>
                    <div><span class="sys-key">Local IP:</span><span class="sys-val">${data.ip}</span></div>
                    <div><span class="sys-key">Locale:</span><span class="sys-val">${data.locale}</span></div>
                `;
            });

        let lastNetwork = null;
        let lastTime = null;
        let lastData = null;
        let currentSort = { column: 'memory_percent', direction: 'desc' };

        // Processes page state
        let currentProcessSort = 'memory'; // 'memory', 'cpu', 'threads', 'uptime', 'tree'
        let currentProcessSearch = '';
        let allProcesses = [];

        // Sensors ordering (persisted)
        const SENSOR_ORDER_KEY = 'sensorOrder';
        let lastSensorItemKeys = [];

        function getSensorItemKey(item) {
            if (!item) return 'unknown';
            if (item.type === 'fan') return `fan:${item.label || 'unknown'}`;
            return `temp:${item.chip || 'unknown'}:${item.label || item.chip || 'unknown'}`;
        }

        function loadSensorOrder() {
            try {
                const raw = localStorage.getItem(SENSOR_ORDER_KEY);
                const parsed = raw ? JSON.parse(raw) : null;
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function saveSensorOrder(order) {
            try {
                localStorage.setItem(SENSOR_ORDER_KEY, JSON.stringify(order));
            } catch {
                // ignore
            }
        }

        function orderItemsByStoredOrder(items, keyFn) {
            const order = loadSensorOrder();
            if (!order.length) return items;

            const rank = new Map();
            order.forEach((k, i) => rank.set(k, i));
            return items.slice().sort((a, b) => {
                const ka = keyFn(a);
                const kb = keyFn(b);
                const ra = rank.has(ka) ? rank.get(ka) : Number.POSITIVE_INFINITY;
                const rb = rank.has(kb) ? rank.get(kb) : Number.POSITIVE_INFINITY;
                if (ra !== rb) return ra - rb;
                return ka.localeCompare(kb);
            });
        }

        function applySensorDragAndDrop(container) {
            if (!container) return;

            container.querySelectorAll('[data-sensor-key]').forEach(el => {
                el.addEventListener('dragstart', (e) => {
                    const key = el.getAttribute('data-sensor-key');
                    if (!key) return;
                    el.classList.add('sensor-dragging');
                    try {
                        e.dataTransfer.setData('text/plain', key);
                        e.dataTransfer.effectAllowed = 'move';
                    } catch {
                        // ignore
                    }
                });

                el.addEventListener('dragend', () => {
                    el.classList.remove('sensor-dragging');
                    container.querySelectorAll('.sensor-drop-target').forEach(t => t.classList.remove('sensor-drop-target'));
                });

                el.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    el.classList.add('sensor-drop-target');
                    try { e.dataTransfer.dropEffect = 'move'; } catch {}
                });

                el.addEventListener('dragleave', () => {
                    el.classList.remove('sensor-drop-target');
                });

                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    el.classList.remove('sensor-drop-target');

                    let draggedKey = '';
                    try { draggedKey = e.dataTransfer.getData('text/plain'); } catch {}
                    if (!draggedKey) return;

                    const targetKey = el.getAttribute('data-sensor-key');
                    if (!targetKey || draggedKey === targetKey) return;

                    const keys = lastSensorItemKeys.slice();
                    const from = keys.indexOf(draggedKey);
                    const to = keys.indexOf(targetKey);
                    if (from === -1 || to === -1) return;

                    // Remove dragged
                    keys.splice(from, 1);

                    // Insert before/after target based on pointer position
                    const rect = el.getBoundingClientRect();
                    const before = (e.clientY - rect.top) < (rect.height / 2);
                    const insertAt = before ? (from < to ? to - 1 : to) : (from < to ? to : to + 1);
                    const clamped = Math.max(0, Math.min(keys.length, insertAt));
                    keys.splice(clamped, 0, draggedKey);

                    saveSensorOrder(keys);
                    if (lastData) {
                        _renderStatsInternal(lastData);
                    }
                });
            });
        }

        function setSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            if (lastData) {
                _renderStatsInternal(lastData);
            }
        }

        // Process sorting function
        function setProcessSort(sortType) {
            currentProcessSort = sortType;
            
            // Update active button UI
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.sort-btn').classList.add('active');
            
            // Save preference
            localStorage.setItem('processSortMode', sortType);
            
            // Re-render
            filterAndRenderProcesses();
        }

        // Filter and render processes based on search and sort
        function filterAndRenderProcesses() {
            const searchInput = document.getElementById('proc-search');
            currentProcessSearch = (searchInput ? searchInput.value : '').toLowerCase();
            
            let filtered = allProcesses.filter(proc => {
                if (!currentProcessSearch) return true;
                const searchStr = currentProcessSearch;
                return (
                    proc.name.toLowerCase().includes(searchStr) ||
                    proc.pid.toString().includes(searchStr) ||
                    (proc.username && proc.username.toLowerCase().includes(searchStr))
                );
            });

            // Sort based on current mode
            if (currentProcessSort === 'tree') {
                renderProcessTree(filtered);
            } else {
                // Perform sorting
                filtered.sort((a, b) => {
                    let valA, valB;
                    switch(currentProcessSort) {
                        case 'cpu':
                            valA = a.cpu_percent || 0;
                            valB = b.cpu_percent || 0;
                            return valB - valA; // Descending
                        case 'threads':
                            valA = a.num_threads || 0;
                            valB = b.num_threads || 0;
                            return valB - valA;
                        case 'uptime':
                            valA = a.uptime_seconds || 0;
                            valB = b.uptime_seconds || 0;
                            return valB - valA;
                        case 'memory':
                        default:
                            valA = a.memory_percent || 0;
                            valB = b.memory_percent || 0;
                            return valB - valA;
                    }
                });
                renderProcessList(filtered);
            }
            
            updateProcessStats();
        }

        // Render process list (for non-tree views)
        function renderProcessList(processes) {
            const container = document.getElementById('process-container');
            container.innerHTML = '';
            
            if (processes.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No processes found</div>';
                return;
            }
            
            processes.forEach(proc => {
                const div = document.createElement('div');
                div.className = 'process-item level-0';
                div.style.cursor = 'pointer';
                
                const cpuPercent = (proc.cpu_percent || 0).toFixed(1);
                const memPercent = (proc.memory_percent || 0).toFixed(1);
                const uptime = proc.uptime || '-';

                const role = localStorage.getItem('role');
                const isAdmin = role === 'admin';
                
                div.innerHTML = `
                    <div class="process-info">
                        <div class="process-name">[${proc.pid}] ${proc.name}</div>
                        <div class="process-meta">${proc.username || '-'} • ${proc.num_threads || 0} threads • ${uptime}</div>
                    </div>
                    <div class="process-bars">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="min-width: 80px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim);">CPU</div>
                                <div class="progress-bg" style="height: 4px;">
                                    <div class="progress-fill" style="width: ${cpuPercent}%; background: var(--accent-cpu);"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--accent-cpu);">${cpuPercent}%</div>
                            </div>
                            <div style="min-width: 80px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim);">Memory</div>
                                <div class="progress-bg" style="height: 4px;">
                                    <div class="progress-fill" style="width: ${memPercent}%; background: var(--accent-mem);"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--accent-mem);">${memPercent}%</div>
                            </div>
                            ${(isAdmin && proc.pid > 1) ? `
                            <div style="margin-left: 10px; display: flex; align-items: center;">
                                <button onclick="event.stopPropagation(); handleKillProcess(${proc.pid});" style="background: var(--accent-cpu); border: none; color: white; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="Kill process">
                                    <i class=\"fas fa-times\" style=\"margin-right: 6px;\"></i>Kill
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', () => showProcDetail(proc.pid));
                container.appendChild(div);
            });
        }

        // Render process tree (hierarchical)
        function renderProcessTree(processes) {
            const container = document.getElementById('process-container');
            container.innerHTML = '';
            
            if (processes.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No processes found</div>';
                return;
            }
            
            // Create PID map for faster lookup
            const pidMap = {};
            processes.forEach(p => { pidMap[p.pid] = p; });
            
            // Find root processes (no parent in filtered list)
            const rootProcesses = processes.filter(p => !pidMap[p.ppid]);
            
            // Render each root and its children
            rootProcesses.forEach(root => {
                renderProcessTreeNode(root, processes, pidMap, 0, container);
            });
        }

        // Helper to render a process node and its children
        function renderProcessTreeNode(proc, allProcs, pidMap, level, container) {
            const div = document.createElement('div');
            div.className = `process-item level-${Math.min(level, 4)}`;
            div.style.cursor = 'pointer';
            div.style.marginLeft = (level * 20) + 'px';
            
            const cpuPercent = (proc.cpu_percent || 0).toFixed(1);
            const memPercent = (proc.memory_percent || 0).toFixed(1);
            const uptime = proc.uptime || '-';

            const role = localStorage.getItem('role');
            const isAdmin = role === 'admin';
            
            // Check if has children
            const hasChildren = proc.children && proc.children.length > 0;
            const expandIcon = hasChildren ? '<i class="fas fa-chevron-right" style="margin-right: 5px; transition: transform 0.2s;"></i>' : '<span style="margin-right: 5px; display: inline-block; width: 16px;"></span>';
            
            div.innerHTML = `
                <div class="process-info" style="display: flex; gap: 10px; flex-grow: 1;">
                    <div style="display: flex; align-items: center;">${expandIcon}</div>
                    <div style="flex: 1;">
                        <div class="process-name">[${proc.pid}] ${proc.name}</div>
                        <div class="process-meta">${proc.username || '-'} • ${proc.num_threads || 0} threads • ${uptime}</div>
                    </div>
                </div>
                <div class="process-bars" style="display: flex; gap: 15px; align-items: center;">
                    <div style="min-width: 70px;">
                        <div class="progress-bg" style="height: 4px;">
                            <div class="progress-fill" style="width: ${cpuPercent}%; background: var(--accent-cpu);"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--accent-cpu);">${cpuPercent}%</div>
                    </div>
                    <div style="min-width: 70px;">
                        <div class="progress-bg" style="height: 4px;">
                            <div class="progress-fill" style="width: ${memPercent}%; background: var(--accent-mem);"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--accent-mem);">${memPercent}%</div>
                    </div>
                    ${(isAdmin && proc.pid > 1) ? `
                    <div style="margin-left: 10px; display: flex; align-items: center;">
                        <button onclick="event.stopPropagation(); handleKillProcess(${proc.pid});" style="background: var(--accent-cpu); border: none; color: white; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="Kill process">
                            <i class=\"fas fa-times\" style=\"margin-right: 6px;\"></i>Kill
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            div.addEventListener('click', (e) => {
                if (hasChildren && e.target.closest('.fas')) {
                    // Toggle children visibility
                    const childrenContainer = div.nextElementSibling;
                    if (childrenContainer && childrenContainer.classList.contains('children-group')) {
                        childrenContainer.style.display = childrenContainer.style.display === 'none' ? '' : 'none';
                        const icon = div.querySelector('.fas');
                        if (icon) icon.style.transform = childrenContainer.style.display === 'none' ? '' : 'rotate(90deg)';
                    }
                } else {
                    showProcDetail(proc.pid);
                }
            });
            
            container.appendChild(div);
            
            // Render children
            if (hasChildren && proc.children) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'children-group';
                
                proc.children.forEach(child => {
                    renderProcessTreeNode(child, allProcs, pidMap, level + 1, childrenContainer);
                });
                
                container.appendChild(childrenContainer);
            }
        }

        // Show process detail modal
        function showProcDetail(pid) {
            const proc = allProcesses.find(p => p.pid === pid);
            if (!proc) return;
            
            const modal = document.getElementById('proc-detail-modal');
            const titleEl = document.getElementById('proc-detail-name');
            const contentEl = document.getElementById('proc-detail-content');

            const role = localStorage.getItem('role');
            const isAdmin = role === 'admin';
            
            titleEl.innerText = `${proc.name} (PID: ${proc.pid})`;
            
            contentEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Process ID</div>
                        <div style="font-weight: bold; color: var(--accent-cpu);">${proc.pid}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Parent PID</div>
                        <div style="font-weight: bold; color: var(--accent-cpu);">${proc.ppid || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">User</div>
                        <div style="font-weight: bold;">${proc.username || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Threads</div>
                        <div style="font-weight: bold; color: var(--accent-mem);">${proc.num_threads || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">CPU Usage</div>
                        <div style="font-weight: bold; color: var(--accent-cpu);">${(proc.cpu_percent || 0).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Memory Usage</div>
                        <div style="font-weight: bold; color: var(--accent-mem);">${(proc.memory_percent || 0).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Uptime</div>
                        <div style="font-weight: bold;">${proc.uptime || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Status</div>
                        <div style="font-weight: bold;">${proc.status || '-'}</div>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px;">Command Line</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; word-break: break-all; color: #90ee90;">
                        ${(proc.cmdline || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px;">Working Directory</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                        ${(proc.cwd || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                </div>
                ${proc.io_read !== '-' ? `
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">I/O Read</div>
                        <div style="font-weight: bold; color: var(--accent-net);">${proc.io_read || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">I/O Write</div>
                        <div style="font-weight: bold; color: var(--accent-net);">${proc.io_write || '-'}</div>
                    </div>
                </div>
                ` : ''}

                ${(isAdmin && proc.pid > 1) ? `
                <div style="margin-top: 18px; display: flex; justify-content: flex-end;">
                    <button onclick="handleKillProcess(${proc.pid});" style="background: var(--accent-cpu); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;" title="Kill process">
                        <i class="fas fa-times" style="margin-right: 6px;"></i>Kill Process
                    </button>
                </div>
                ` : ''}
            `;
            
            modal.style.display = 'flex';
        }

        // Close process detail modal
        function closeProcDetail() {
            document.getElementById('proc-detail-modal').style.display = 'none';
        }

        // Admin-only: kill a process by PID
        async function handleKillProcess(pid) {
            const role = localStorage.getItem('role');
            if (role !== 'admin') {
                alert('Forbidden: Admin access required');
                return;
            }

            const proc = allProcesses.find(p => p.pid === pid);
            const name = proc ? proc.name : 'unknown';
            if (!confirm(`Kill process ${name} (PID: ${pid})? This cannot be undone.`)) return;

            try {
                const response = await fetch('/api/process/kill', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid })
                });

                if (response.ok) {
                    closeProcDetail();
                    alert('Kill signal sent. The process list will refresh shortly.');
                    setTimeout(() => {
                        try { filterAndRenderProcesses(); } catch (_) {}
                    }, 500);
                    return;
                }

                const data = await response.json();
                alert('Error: ' + (data.error || 'Kill failed'));
            } catch (err) {
                alert('Failed to kill process');
            }
        }

        // Update process statistics
        function updateProcessStats() {
            if (allProcesses.length === 0) {
                document.getElementById('proc-total').innerText = '0';
                document.getElementById('proc-threads').innerText = '0';
                document.getElementById('proc-avg-cpu').innerText = '0%';
                document.getElementById('proc-avg-mem').innerText = '0%';
                return;
            }
            
            const totalThreads = allProcesses.reduce((sum, p) => sum + (p.num_threads || 0), 0);
            const avgCpu = allProcesses.reduce((sum, p) => sum + (p.cpu_percent || 0), 0) / allProcesses.length;
            const avgMem = allProcesses.reduce((sum, p) => sum + (p.memory_percent || 0), 0) / allProcesses.length;
            
            document.getElementById('proc-total').innerText = allProcesses.length;
            document.getElementById('proc-threads').innerText = totalThreads;
            document.getElementById('proc-avg-cpu').innerText = avgCpu.toFixed(1) + '%';
            document.getElementById('proc-avg-mem').innerText = avgMem.toFixed(1) + '%';
        }

        // Restore sort preference on page load
        window.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('processSortMode');
            if (saved) {
                currentProcessSort = saved;
                const btn = document.querySelector(`.sort-btn[onclick="setProcessSort('${saved}')"]`);
                if (btn) {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            }
            
            // Modal interaction
            const modal = document.getElementById('proc-detail-modal');
            if (modal) {
                // Close on ESC key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.style.display !== 'none') {
                        closeProcDetail();
                    }
                });
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeProcDetail();
                    }
                });
            }
        });

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function drawChart(containerId, data, options = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            const padding = 5;
            
            // Clear container
            container.innerHTML = '';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem; text-align: center; width: 100%;">No Data</div>';
                return;
            }

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.style.overflow = "visible";

            const maxVal = options.max !== undefined ? options.max : Math.max(...data) * 1.1;
            const minVal = options.min !== undefined ? options.min : Math.min(...data) * 0.9;
            const range = maxVal - minVal || 1;

            // Generate path
            let pathD = "";
            const stepX = (width - 2 * padding) / (data.length - 1);
            
            data.forEach((val, i) => {
                const x = padding + i * stepX;
                const y = height - padding - ((val - minVal) / range) * (height - 2 * padding);
                if (i === 0) pathD += `M ${x} ${y}`;
                else pathD += ` L ${x} ${y}`;
            });

            // Gradient for area
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            const gradientId = "grad-" + containerId;
            const gradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradient.setAttribute("id", gradientId);
            gradient.setAttribute("x1", "0%");
            gradient.setAttribute("y1", "0%");
            gradient.setAttribute("x2", "0%");
            gradient.setAttribute("y2", "100%");
            
            const stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop1.setAttribute("offset", "0%");
            stop1.setAttribute("stop-color", options.color || "#ff4757");
            stop1.setAttribute("stop-opacity", "0.5");
            
            const stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop2.setAttribute("offset", "100%");
            stop2.setAttribute("stop-color", options.color || "#ff4757");
            stop2.setAttribute("stop-opacity", "0.05");
            
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            defs.appendChild(gradient);
            svg.appendChild(defs);

            // Area path
            const areaPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            areaPath.setAttribute("d", pathD + ` L ${width - padding} ${height - padding} L ${padding} ${height - padding} Z`);
            areaPath.setAttribute("fill", `url(#${gradientId})`);
            svg.appendChild(areaPath);

            // Line path
            const linePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            linePath.setAttribute("d", pathD);
            linePath.setAttribute("fill", "none");
            linePath.setAttribute("stroke", options.color || "#ff4757");
            linePath.setAttribute("stroke-width", "2");
            svg.appendChild(linePath);

            // Pressure coloring (if enabled)
            if (options.pressure) {
                linePath.setAttribute("stroke", "url(#pressure-grad)");
            }

            svg.appendChild(linePath);

            // Add Min/Max labels
            const fontSize = 10;
            const textStyle = `font-size: ${fontSize}px; fill: var(--text-dim); font-family: monospace;`;
            
            const maxText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            maxText.setAttribute("x", padding);
            maxText.setAttribute("y", padding + fontSize);
            maxText.setAttribute("style", textStyle);
            maxText.textContent = maxVal.toFixed(0);
            svg.appendChild(maxText);

            const minText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            minText.setAttribute("x", padding);
            minText.setAttribute("y", height - padding);
            minText.setAttribute("style", textStyle);
            minText.textContent = minVal.toFixed(0);
            svg.appendChild(minText);

            container.appendChild(svg);
        }

        function drawMemoryPieChart(memoryData) {
            const svg = document.getElementById('mem-pie-chart');
            if (!svg) return;

            // Helper function to convert memory strings to bytes
            function parseMemory(str) {
                const match = str.match(/(\d+\.?\d*)\s*([GMK]iB)/);
                if (!match) return 0;
                
                const value = parseFloat(match[1]);
                const unit = match[2];
                
                const multipliers = {
                    'GiB': 1024 * 1024 * 1024,
                    'MiB': 1024 * 1024,
                    'KiB': 1024,
                };
                
                return value * (multipliers[unit] || 1);
            }

            const totalBytes = parseMemory(memoryData.total);
            const usedBytes = parseMemory(memoryData.used);
            const cachedBytes = parseMemory(memoryData.cached);
            const buffersBytes = parseMemory(memoryData.buffers);
            
            const cacheBufferBytes = cachedBytes + buffersBytes;
            const freeBytes = totalBytes - usedBytes - cacheBufferBytes;

            const segments = [
                { label: 'Used', value: usedBytes, color: '#ff4757' },
                { label: 'Buffer/Cache', value: cacheBufferBytes, color: '#2ed573' },
                { label: 'Free', value: Math.max(0, freeBytes), color: '#888' }
            ].filter(s => s.value > 0);

            // Draw pie chart
            // Draw pie chart
            let currentAngle = -Math.PI / 2;
            const radius = 70;
            const centerX = 90;
            const centerY = 90;

            svg.innerHTML = '';
            
            segments.forEach(segment => {
                const percentage = segment.value / totalBytes;
                const sliceAngle = percentage * 2 * Math.PI;
                
                const x1 = centerX + radius * Math.cos(currentAngle);
                const y1 = centerY + radius * Math.sin(currentAngle);
                
                currentAngle += sliceAngle;
                
                const x2 = centerX + radius * Math.cos(currentAngle);
                const y2 = centerY + radius * Math.sin(currentAngle);
                
                const largeArc = sliceAngle > Math.PI ? 1 : 0;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', segment.color);
                path.setAttribute('stroke', '#121212');
                path.setAttribute('stroke-width', '2');
                svg.appendChild(path);
            });

            // Draw legend
            const legend = document.getElementById('mem-pie-legend');
            if (legend) {
                legend.innerHTML = segments.map(s => `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background-color: ${s.color}; border-radius: 2px;"></div>
                        <div>
                            <div style="font-weight: bold;">${s.label}</div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">${(s.value / totalBytes * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        let websocket = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            if (websocket) {
                // Prevent auto-reconnect from the old socket
                websocket.onclose = null;
                websocket.close();
            }
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            // 检查认证 token
            const token = getAuthToken();
            if (!token) {
                console.warn('No auth token, redirecting to login');
                window.location.href = '/login';
                return;
            }

            const interval = document.getElementById('interval-select').value;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/stats?interval=${interval}`;

            // 通过 Sec-WebSocket-Protocol 传递 Token（避免 URL 泄露）
            websocket = new WebSocket(wsUrl, ['jwt', token]);
            const statusDot = document.getElementById('status-dot');

            websocket.onopen = function() {
                console.log('WebSocket connected');
                statusDot.classList.add('connected');
            };

            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    renderStats(data);
                } catch (e) {
                    console.error('Error processing message:', e);
                }
            };

            websocket.onclose = function() {
                console.log('WebSocket closed');
                statusDot.classList.remove('connected');
                // Try to reconnect in 3 seconds
                reconnectTimer = setTimeout(connectWebSocket, 3000);
            };

            websocket.onerror = function(err) {
                console.error('WebSocket error:', err);
                statusDot.classList.remove('connected');
                websocket.close();
            };
        }

        function changeInterval() {
            connectWebSocket();
        }

        // Helper for DOM reuse
        function updateList(containerId, items, createFn, updateFn) {
            const container = document.getElementById(containerId);
            const children = Array.from(container.children);
            
            // Remove excess
            while (container.children.length > items.length) {
                container.removeChild(container.lastChild);
            }

            items.forEach((item, index) => {
                let el = container.children[index];
                if (!el) {
                    el = createFn(item, index);
                    container.appendChild(el);
                } else {
                    updateFn(el, item, index);
                }
            });
        }

        function renderStats(data) {
            lastData = data;
            requestAnimationFrame(() => {
                _renderStatsInternal(data);
            });
        }

        // GPU Rendering Logic
        const gpuCharts = {}; // Store chart instances

        function renderGPUs(gpus) {
            const gpuGrid = document.getElementById('gpu-grid');
            if (!gpuGrid) return;

            if (!gpus || gpus.length === 0) {
                gpuGrid.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No GPUs detected or driver not loaded.</div>';
                return;
            }
            
            // Check if we need to create cards
            gpus.forEach((gpu, index) => {
                let card = document.getElementById(`gpu-card-${index}`);
                if (!card) {
                    card = createGPUCard(gpu, index);
                    gpuGrid.appendChild(card);
                    initGPUCharts(index);
                }
                updateGPUCard(gpu, index);
            });
        }

        function createGPUCard(gpu, index) {
            const div = document.createElement('div');
            div.className = 'card';
            div.id = `gpu-card-${index}`;
            div.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="gpu-name">${gpu.name}</div>
                        <div class="gpu-meta">
                            <i class="fas fa-microchip"></i> ${gpu.vendor} &nbsp;|&nbsp; 
                            <i class="fas fa-map-marker-alt"></i> ${gpu.pci_address} &nbsp;|&nbsp; 
                            <i class="fas fa-terminal"></i> ${gpu.drm_card}
                        </div>
                    </div>
                    <div class="gpu-temp" id="temp-${index}">--°C</div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-item">
                        <span class="stat-label">Frequency</span>
                        <span class="stat-value" id="freq-${index}">--</span> <span style="font-size:0.8em; color:#888">MHz</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Power</span>
                        <span class="stat-value" id="power-${index}">--</span> <span style="font-size:0.8em; color:#888">W</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Load</span>
                        <span class="stat-value" id="load-${index}">--</span> <span style="font-size:0.8em; color:#888">%</span>
                    </div>
                </div>

                <div class="vram-container">
                    <div class="vram-details">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="color:var(--text-dim)">VRAM Usage</span>
                            <span id="vram-text-${index}" style="font-weight:bold">-- / --</span>
                        </div>
                        <div class="vram-bar-bg">
                            <div id="vram-bar-${index}" class="vram-bar-fill"></div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chart-load-${index}"></canvas>
                </div>
            `;
            return div;
        }

        function initGPUCharts(index) {
            const ctxLoad = document.getElementById(`chart-load-${index}`).getContext('2d');
            gpuCharts[`load-${index}`] = new Chart(ctxLoad, {
                type: 'line',
                data: {
                    labels: Array(30).fill(''),
                    datasets: [
                        { 
                            label: 'Load %', 
                            data: Array(30).fill(0), 
                            borderColor: '#ff4757', 
                            backgroundColor: 'rgba(255, 71, 87, 0.1)',
                            fill: true,
                            tension: 0.4, 
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        { 
                            label: 'Power W', 
                            data: Array(30).fill(0), 
                            borderColor: '#ffa502', 
                            backgroundColor: 'transparent',
                            tension: 0.4, 
                            pointRadius: 0, 
                            borderWidth: 2,
                            yAxisID: 'y1' 
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { color: '#888', boxWidth: 10 } } },
                    scales: {
                        x: { display: false },
                        y: { 
                            min: 0, 
                            max: 100, 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#888' },
                            title: { display: true, text: 'Load %', color: '#ff4757' }
                        },
                        y1: { 
                            position: 'right', 
                            grid: { display: false }, 
                            ticks: { color: '#ffa502' },
                            title: { display: true, text: 'Power W', color: '#ffa502' }
                        }
                    },
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            });
        }

        function updateGPUCard(gpu, index) {
            const tempEl = document.getElementById(`temp-${index}`);
            if (tempEl) tempEl.innerText = gpu.temp_c ? `${gpu.temp_c.toFixed(1)}°C` : 'N/A';
            
            const freqEl = document.getElementById(`freq-${index}`);
            if (freqEl) freqEl.innerText = gpu.freq_mhz ? gpu.freq_mhz.toFixed(0) : '--';
            
            const powerEl = document.getElementById(`power-${index}`);
            if (powerEl) powerEl.innerText = gpu.power_w ? gpu.power_w.toFixed(1) : '--';
            
            const loadEl = document.getElementById(`load-${index}`);
            if (loadEl) loadEl.innerText = gpu.load_percent ? gpu.load_percent.toFixed(1) : '--';
            
            const vramTextEl = document.getElementById(`vram-text-${index}`);
            if (vramTextEl) vramTextEl.innerText = `${gpu.vram_used} / ${gpu.vram_total}`;
            
            // Update VRAM Bar
            const vramPercent = gpu.vram_percent || 0;
            const vramBarEl = document.getElementById(`vram-bar-${index}`);
            if (vramBarEl) vramBarEl.style.width = `${vramPercent}%`;

            // Update Load/Power Chart
            if (gpuCharts[`load-${index}`]) {
                const chart = gpuCharts[`load-${index}`];
                const load = gpu.load_percent || 0;
                const power = gpu.power_w || 0;
                
                chart.data.datasets[0].data.push(load);
                chart.data.datasets[0].data.shift();
                
                chart.data.datasets[1].data.push(power);
                chart.data.datasets[1].data.shift();
                
                chart.update();
            }
        }

        function _renderStatsInternal(data) {
            // Boot Time
            document.getElementById('boot-time').innerText = 'Up since: ' + data.boot_time;

            // Check active page to optimize rendering
            const isCpuPage = document.getElementById('page-cpu').classList.contains('active');
            const isMemPage = document.getElementById('page-memory').classList.contains('active');
            const isGeneralPage = document.getElementById('page-general').classList.contains('active');

            // General Page CPU Widget
            if (isGeneralPage) {
                document.getElementById('cpu-total-text').innerText = data.cpu.percent + '%';
                document.getElementById('cpu-total-bar').style.width = data.cpu.percent + '%';
                if (data.cpu.freq && data.cpu.freq.avg !== undefined) {
                    document.getElementById('cpu-freq').innerText = data.cpu.freq.avg.toFixed(0) + ' MHz';
                }
                
                // Change container style to column for list view
                const cpuCoresContainer = document.getElementById('cpu-cores');
                if (cpuCoresContainer) {
                    cpuCoresContainer.style.display = 'flex';
                    cpuCoresContainer.style.flexDirection = 'column';
                    cpuCoresContainer.style.gap = '10px';
                    cpuCoresContainer.style.marginTop = '15px';
                    cpuCoresContainer.style.maxHeight = '300px';
                    cpuCoresContainer.style.overflowY = 'auto';
                }

                updateList('cpu-cores', data.cpu.per_core, 
                    (core, index) => {
                        const div = document.createElement('div');
                        div.className = 'stat-group';
                        div.style.marginBottom = '0';
                        div.innerHTML = `
                            <div class="stat-label">
                                <span>Core ${index} <span class="core-freq" style="color: var(--text-dim); font-size: 0.8em; margin-left: 5px;"></span></span>
                                <span class="core-val"></span>
                            </div>
                            <div class="progress-bg">
                                <div class="progress-fill cpu-fill core-fill" style="width: 0%;"></div>
                            </div>
                        `;
                        return div;
                    },
                    (el, core, index) => {
                        const freq = data.cpu.freq.per_core[index] ? data.cpu.freq.per_core[index].toFixed(0) : '-';
                        el.querySelector('.core-freq').innerText = `@ ${freq} MHz`;
                        el.querySelector('.core-val').innerText = `${core}%`;
                        el.querySelector('.core-fill').style.width = `${core}%`;
                    }
                );
            }

            // CPU Details Page
            if (isCpuPage && data.cpu.load_avg) {
                document.getElementById('cpu-load-1').innerText = data.cpu.load_avg[0].toFixed(2);
                document.getElementById('cpu-load-5').innerText = data.cpu.load_avg[1].toFixed(2);
                document.getElementById('cpu-load-15').innerText = data.cpu.load_avg[2].toFixed(2);

                // Stats
                if (data.cpu.stats) {
                    document.getElementById('cpu-ctx-switches').innerText = data.cpu.stats.ctx_switches.toLocaleString();
                    document.getElementById('cpu-interrupts').innerText = data.cpu.stats.interrupts.toLocaleString();
                    document.getElementById('cpu-syscalls').innerText = data.cpu.stats.syscalls.toLocaleString();
                }

                // CPU Times
                if (data.cpu.times) {
                    const timeLabels = {
                        'user': { color: '#ff4757', label: 'User' },
                        'system': { color: '#2ed573', label: 'System' },
                        'idle': { color: '#2f3542', label: 'Idle' },
                        'iowait': { color: '#ffa502', label: 'IO Wait' },
                        'irq': { color: '#1e90ff', label: 'IRQ' },
                        'softirq': { color: '#70a1ff', label: 'Soft IRQ' }
                    };
                    
                    const timesData = Object.entries(data.cpu.times)
                        .filter(([key, val]) => timeLabels[key] && val > 0)
                        .map(([key, val]) => ({ key, val, ...timeLabels[key] }))
                        .sort((a, b) => b.val - a.val);

                    updateList('cpu-times-container', timesData,
                        (item) => {
                            const div = document.createElement('div');
                            div.innerHTML = `
                                <div class="stat-label">
                                    <span>${item.label}</span>
                                    <span class="time-val"></span>
                                </div>
                                <div class="progress-bg">
                                    <div class="progress-fill time-fill" style="width: 0%"></div>
                                </div>
                            `;
                            return div;
                        },
                        (el, item) => {
                            el.querySelector('.time-val').innerText = item.val.toFixed(1) + '%';
                            el.querySelector('.time-fill').style.width = item.val + '%';
                            el.querySelector('.time-fill').style.backgroundColor = item.color;
                        }
                    );
                }

                // CPU Information
                if (data.cpu.info) {
                    const info = data.cpu.info;
                    document.getElementById('cpu-model').innerText = info.model || '-';
                    document.getElementById('cpu-arch').innerText = info.architecture || '-';
                    document.getElementById('cpu-info-cores').innerText = info.cores || '-';
                    document.getElementById('cpu-threads').innerText = info.threads || '-';
                    const freqRange = info.min_freq && info.max_freq 
                        ? `${info.min_freq.toFixed(0)} - ${info.max_freq.toFixed(0)} MHz`
                        : '-';
                    document.getElementById('cpu-freq-range').innerText = freqRange;
                }

                // CPU Temperature Trends
                if (data.cpu.temp_history && data.cpu.temp_history.length > 0) {
                    const history = data.cpu.temp_history;
                    drawChart('cpu-temp-trend', history, { color: '#ff6b6b', min: 0, max: 100 });
                    
                    const latestTemp = history[history.length - 1] || 0;
                    document.getElementById('cpu-temp-avg').innerText = `${latestTemp.toFixed(1)}°C`;
                }

                // Detailed Cores
                const detailedCoresContainer = document.getElementById('cpu-detailed-cores');
                if (detailedCoresContainer) {
                    detailedCoresContainer.style.display = 'grid';
                    detailedCoresContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                    detailedCoresContainer.style.gap = '10px';
                }

                updateList('cpu-detailed-cores', data.cpu.per_core,
                    (core, index) => {
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.style.padding = '10px';
                        div.style.marginBottom = '0';
                        div.style.textAlign = 'center';
                        div.style.background = 'rgba(255,255,255,0.03)';
                        div.innerHTML = `
                            <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px;">Core ${index}</div>
                            <div class="core-val" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-cpu); margin-bottom: 5px;"></div>
                            <div class="progress-bg" style="height: 4px; background: rgba(255,255,255,0.1);">
                                <div class="progress-fill core-fill" style="width: 0%; background: var(--accent-cpu);"></div>
                            </div>
                            <div class="core-freq" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 5px;"></div>
                        `;
                        return div;
                    },
                    (el, core, index) => {
                        el.querySelector('.core-val').innerText = core + '%';
                        el.querySelector('.core-fill').style.width = core + '%';
                        const freq = data.cpu.freq.per_core[index] ? data.cpu.freq.per_core[index].toFixed(0) : '-';
                        el.querySelector('.core-freq').innerText = `${freq} MHz`;
                    }
                );
            }

            // Memory
            document.getElementById('mem-text').innerText = `${data.memory.used} / ${data.memory.total}`;
            document.getElementById('mem-percent').innerText = data.memory.percent + '%';
            document.getElementById('mem-bar').style.width = data.memory.percent + '%';

            // Memory Details
            const memDetails = [
                { label: 'Buffers', val: data.memory.buffers },
                { label: 'Cached', val: data.memory.cached },
                { label: 'Shared', val: data.memory.shared },
                { label: 'Slab', val: data.memory.slab },
                { label: 'Active', val: data.memory.active },
                { label: 'Inactive', val: data.memory.inactive },
            ];
            
            updateList('mem-details', memDetails,
                (item) => {
                    const div = document.createElement('div');
                    div.innerHTML = `<span style="color: var(--text-dim);">${item.label}:</span> <span class="mem-val" style="float: right;">${item.val}</span>`;
                    return div;
                },
                (el, item) => {
                    el.querySelector('.mem-val').innerText = item.val;
                }
            );

            // Memory Page
            if (isMemPage) {
                // Memory Stats
                document.getElementById('mem-page-text').innerText = `${data.memory.used} / ${data.memory.total}`;
                document.getElementById('mem-page-percent').innerText = data.memory.percent + '%';
                document.getElementById('mem-page-bar').style.width = data.memory.percent + '%';

                // Memory Usage Trends
                if (data.memory.history && data.memory.history.length > 0) {
                    const history = data.memory.history;
                    const latest = history[history.length - 1] || 0;
                    
                    // Determine color based on pressure
                    let color = '#2ed573'; // Green
                    if (latest > 80) color = '#ff4757'; // Red
                    else if (latest > 60) color = '#ffa502'; // Yellow
                    
                    drawChart('mem-trend', history, { color: color, min: 0, max: 100 });
                    document.getElementById('mem-trend-current').innerText = `${latest.toFixed(1)}%`;
                }

                // Memory Details
                const memDetails = [
                    { label: 'Available', val: data.memory.available },
                    { label: 'Buffers', val: data.memory.buffers },
                    { label: 'Cached', val: data.memory.cached },
                    { label: 'Shared', val: data.memory.shared },
                    { label: 'Slab', val: data.memory.slab },
                    { label: 'Active', val: data.memory.active },
                    { label: 'Inactive', val: data.memory.inactive }
                ];
                
                updateList('mem-page-details', memDetails,
                    (item) => {
                        const div = document.createElement('div');
                        div.innerHTML = `<span style="color: var(--text-dim);">${item.label}:</span> <span class="mem-val" style="float: right;">${item.val}</span>`;
                        return div;
                    },
                    (el, item) => {
                        el.querySelector('.mem-val').innerText = item.val;
                    }
                );

                // Swap Stats
                if (data.swap) {
                    document.getElementById('swap-page-text').innerText = `${data.swap.used} / ${data.swap.total}`;
                    document.getElementById('swap-page-percent').innerText = data.swap.percent + '%';
                    document.getElementById('swap-page-bar').style.width = data.swap.percent + '%';
                }

                // Memory Pie Chart
                if (data.memory) {
                    drawMemoryPieChart(data.memory);
                }

                // Process Table
                if (data.processes) {
                    document.getElementById('proc-count').innerText = `${data.processes.length} processes`;
                    
                    let sortedProcs = [...data.processes];
                    sortedProcs.sort((a, b) => {
                        let valA = a[currentSort.column];
                        let valB = b[currentSort.column];
                        
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                        
                        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    });

                    updateList('process-table-body', sortedProcs,
                        (proc) => {
                            const tr = document.createElement('tr');
                            tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                            tr.innerHTML = `
                                <td style="padding: 8px; color: var(--accent-cpu); font-family: monospace;"></td>
                                <td style="padding: 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></td>
                                <td style="padding: 8px; color: var(--text-dim);"></td>
                                <td style="padding: 8px; text-align: right; font-family: monospace;"></td>
                                <td style="padding: 8px; text-align: right; font-family: monospace; color: var(--accent-net);"></td>
                                <td style="padding: 8px; text-align: right; font-family: monospace; color: var(--accent-mem);"></td>
                            `;
                            return tr;
                        },
                        (el, proc) => {
                            el.children[0].innerText = proc.pid;
                            el.children[1].innerText = proc.name;
                            el.children[1].title = proc.name;
                            el.children[2].innerText = proc.username || '-';
                            el.children[3].innerText = (proc.num_threads ?? 0).toString();
                            el.children[4].innerText = (proc.cpu_percent ?? 0).toFixed(1) + '%';
                            el.children[5].innerText = (proc.memory_percent ?? 0).toFixed(1) + '%';
                        }
                    );
                }
            }

            // Top Processes (General Page Widget)
            if (isGeneralPage && data.processes) {
                // Limit to top 10 processes
                const topProcesses = data.processes.slice(0, 10);
                updateList('processes-container', topProcesses,
                    (proc) => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        div.style.padding = '2px 0';
                        div.innerHTML = `
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%;" class="proc-name"></span>
                            <span>
                                <span class="proc-mem" style="color: var(--accent-mem); font-weight: bold;"></span>
                            </span>
                        `;
                        return div;
                    },
                    (el, proc) => {
                        el.querySelector('.proc-name').innerText = `[${proc.pid}] ${proc.name}`;
                        el.querySelector('.proc-mem').innerText = proc.memory_percent.toFixed(1) + '%';
                    }
                );
            }

            // Processes Page
            const isProcessesPage = document.getElementById('page-processes').classList.contains('active');
            if (isProcessesPage && data.processes) {
                // Update allProcesses with uptime_seconds for sorting
                allProcesses = data.processes.map(p => {
                    let uptimeSeconds = 0;
                    if (p.uptime) {
                        const match = p.uptime.match(/(\d+)([smhd])/);
                        if (match) {
                            const num = parseInt(match[1]);
                            const unit = match[2];
                            switch(unit) {
                                case 's': uptimeSeconds = num; break;
                                case 'm': uptimeSeconds = num * 60; break;
                                case 'h': uptimeSeconds = num * 3600; break;
                                case 'd': uptimeSeconds = num * 86400; break;
                            }
                        }
                    }
                    return { ...p, uptime_seconds: uptimeSeconds };
                });
                
                // Render the processes
                filterAndRenderProcesses();
            }

            // Sensors
            const sensorsContainer = document.getElementById('sensors-container');
            let sensorsList = [];
            
            if (data.fans) {
                data.fans.forEach(fan => sensorsList.push({type: 'fan', ...fan}));
            }
            if (data.sensors) {
                for (const [chip, sensors] of Object.entries(data.sensors)) {
                    sensors.forEach(sensor => sensorsList.push({type: 'temp', chip: chip, ...sensor}));
                }
            }

            if (sensorsList.length === 0) {
                sensorsContainer.innerHTML = '<div class="no-data" style="color: var(--text-dim); text-align: center; padding: 20px;">No sensors detected</div>';
            } else {
                if (sensorsContainer.querySelector('.no-data')) {
                    sensorsContainer.innerHTML = '';
                }
                sensorsList = orderItemsByStoredOrder(sensorsList, getSensorItemKey);
                lastSensorItemKeys = sensorsList.map(getSensorItemKey);

                updateList('sensors-container', sensorsList,
                    (item) => {
                        const div = document.createElement('div');
                        const key = getSensorItemKey(item);
                        div.className = 'sensor-item';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        div.style.padding = '2px 0';
                        div.classList.add('sensor-draggable');
                        div.setAttribute('draggable', 'true');
                        div.setAttribute('data-sensor-key', key);
                        div.innerHTML = `
                            <span class="sensor-label" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 75%;"></span>
                            <span class="sensor-value" style="font-weight: bold;"></span>
                        `;
                        return div;
                    },
                    (el, item) => {
                        const labelSpan = el.querySelector('.sensor-label');
                        const valSpan = el.querySelector('.sensor-value');
                        
                        if (item.type === 'fan') {
                            labelSpan.innerText = item.label;
                            valSpan.style.color = 'var(--accent-net)';
                            valSpan.innerText = `${item.current} RPM`;
                        } else {
                            labelSpan.innerText = item.label || item.chip;
                            valSpan.style.color = item.current > 70 ? '#ff4757' : '#2ed573';
                            valSpan.innerText = `${item.current}°C`;
                        }
                    }
                );

                applySensorDragAndDrop(sensorsContainer);
            }

            // Power
            const powerContainer = document.getElementById('power-container');
            let powerList = [];
            
            if (data.power) {
                if (data.power.percent !== undefined) {
                    powerList.push({type: 'battery', ...data.power});
                }
                if (data.power.consumption_watts !== undefined) {
                    powerList.push({type: 'total', watts: data.power.consumption_watts});
                }
                if (data.power.rapl) {
                    for (const [domain, watts] of Object.entries(data.power.rapl)) {
                        if (domain.includes('Package') && data.power.consumption_watts == watts) continue;
                        powerList.push({type: 'rapl', domain: domain, watts: watts});
                    }
                }
            }

            if (powerList.length === 0) {
                powerContainer.innerHTML = '<div class="no-data" style="color: var(--text-dim); text-align: center; padding: 10px;">No power data</div>';
            } else {
                if (powerContainer.querySelector('.no-data')) {
                    powerContainer.innerHTML = '';
                }
                updateList('power-container', powerList,
                    (item) => {
                        const div = document.createElement('div');
                        div.className = 'sensor-item';
                        div.innerHTML = `<span></span><span class="sensor-value"></span>`;
                        return div;
                    },
                    (el, item) => {
                        const labelSpan = el.firstElementChild;
                        const valSpan = el.lastElementChild;
                        
                        if (item.type === 'battery') {
                            labelSpan.innerText = 'Battery';
                            valSpan.innerText = `${item.percent}% ${item.power_plugged ? '(Charging)' : ''}`;
                            valSpan.style.color = 'inherit';
                        } else if (item.type === 'total') {
                            labelSpan.innerText = 'Power Draw';
                            valSpan.innerText = `${item.watts} W`;
                            valSpan.style.color = '#ffa502';
                        } else {
                            labelSpan.innerText = item.domain;
                            labelSpan.style.color = 'var(--text-dim)';
                            labelSpan.style.fontSize = '0.85em';
                            labelSpan.style.paddingLeft = '10px';
                            valSpan.innerText = `${item.watts} W`;
                            valSpan.style.fontSize = '0.85em';
                            valSpan.style.color = 'inherit';
                        }
                    }
                );
            }

            // Network
            if (data.network) {
                // General Page
                if (document.getElementById('net-sent')) {
                    document.getElementById('net-sent').innerText = data.network.bytes_sent;
                    document.getElementById('net-recv').innerText = data.network.bytes_recv;
                }
                
                // Network Page
                if (document.getElementById('net-page-sent')) {
                    document.getElementById('net-page-sent').innerText = data.network.bytes_sent;
                    document.getElementById('net-page-recv').innerText = data.network.bytes_recv;
                }

                if (lastNetwork && lastTime) {
                    const now = Date.now();
                    const timeDiff = (now - lastTime) / 1000; // seconds
                    if (timeDiff > 0) {
                        const sentDiff = data.network.raw_sent - lastNetwork.raw_sent;
                        const recvDiff = data.network.raw_recv - lastNetwork.raw_recv;
                        
                        const sentSpeed = sentDiff / timeDiff;
                        const recvSpeed = recvDiff / timeDiff;
                        const sentSpeedStr = formatSize(sentSpeed) + '/s';
                        const recvSpeedStr = formatSize(recvSpeed) + '/s';

                        if (document.getElementById('net-speed-sent')) {
                            document.getElementById('net-speed-sent').innerText = sentSpeedStr;
                            document.getElementById('net-speed-recv').innerText = recvSpeedStr;
                        }
                        if (document.getElementById('net-page-speed-sent')) {
                            document.getElementById('net-page-speed-sent').innerText = sentSpeedStr;
                            document.getElementById('net-page-speed-recv').innerText = recvSpeedStr;
                        }
                    }
                }
                lastNetwork = data.network;
                lastTime = Date.now();

                // Network Page Interfaces
                const isNetPage = document.getElementById('page-net-traffic').classList.contains('active');
                if (isNetPage) {
                    // TCP Connection States
                    if (data.network.connection_states) {
                        const states = data.network.connection_states;
                        document.getElementById('tcp-established').innerText = states.ESTABLISHED || 0;
                        document.getElementById('tcp-time-wait').innerText = states.TIME_WAIT || 0;
                        document.getElementById('tcp-close-wait').innerText = states.CLOSE_WAIT || 0;
                        document.getElementById('tcp-listen').innerText = states.LISTEN || 0;
                        document.getElementById('tcp-syn-sent').innerText = states.SYN_SENT || 0;
                        document.getElementById('tcp-syn-recv').innerText = states.SYN_RECV || 0;
                        document.getElementById('tcp-fin-wait1').innerText = states.FIN_WAIT1 || 0;
                        document.getElementById('tcp-fin-wait2').innerText = states.FIN_WAIT2 || 0;
                        document.getElementById('tcp-last-ack').innerText = states.LAST_ACK || 0;
                    }

                    // Socket Stats
                    if (data.network.sockets) {
                        document.getElementById('net-tcp-count').innerText = data.network.sockets.tcp;
                        document.getElementById('net-udp-count').innerText = data.network.sockets.udp;
                        document.getElementById('net-tcp-tw').innerText = data.network.sockets.tcp_tw;
                    }

                    // Network Errors & Packet Loss
                    if (data.network.errors) {
                        document.getElementById('net-errors-in').innerText = data.network.errors.total_errors_in || 0;
                        document.getElementById('net-errors-out').innerText = data.network.errors.total_errors_out || 0;
                        document.getElementById('net-drops-in').innerText = data.network.errors.total_drops_in || 0;
                        document.getElementById('net-drops-out').innerText = data.network.errors.total_drops_out || 0;
                    }

                    // Per-Interface Error Details
                    if (data.network.interfaces) {
                        const interfaces = Object.entries(data.network.interfaces)
                            .map(([name, stats]) => ({name, ...stats}))
                            .filter(i => (i.errors_in || 0) > 0 || (i.errors_out || 0) > 0 || (i.drops_in || 0) > 0 || (i.drops_out || 0) > 0);
                        
                        const errorContainer = document.getElementById('net-error-details');
                        if (interfaces.length === 0) {
                            errorContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-dim); padding: 10px;">No errors or drops detected</div>';
                        } else {
                            errorContainer.innerHTML = interfaces.map(iface => `
                                <div style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 3px solid ${(iface.errors_in + iface.errors_out) > 0 ? '#ff6b6b' : '#ffa94d'};">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${iface.name}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85rem;">
                                        <div style="color: var(--text-dim);">Errors In: <span style="color: #ff6b6b; font-weight: bold;">${iface.errors_in || 0}</span></div>
                                        <div style="color: var(--text-dim);">Errors Out: <span style="color: #ff6b6b; font-weight: bold;">${iface.errors_out || 0}</span></div>
                                        <div style="color: var(--text-dim);">Drops In: <span style="color: #ffa94d; font-weight: bold;">${iface.drops_in || 0}</span></div>
                                        <div style="color: var(--text-dim);">Drops Out: <span style="color: #ffa94d; font-weight: bold;">${iface.drops_out || 0}</span></div>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }

                    // Listening Ports (Network Page)
                    if (data.network && data.network.listening_ports) {
                        const portsContainer = document.getElementById('listening-ports');
                        if (data.network.listening_ports.length > 0) {
                            portsContainer.innerHTML = data.network.listening_ports.map(port => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; border-left: 3px solid var(--accent-net);">
                                    <div>
                                        <div style="font-weight: bold; color: var(--accent-cpu);">Port ${port.port}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-dim);">${port.protocol}</div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            portsContainer.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 10px;">No listening ports</div>';
                        }
                    }

                    if (data.network.interfaces) {
                        const interfaces = Object.entries(data.network.interfaces).map(([name, stats]) => ({name, ...stats}));
                        updateList('net-interfaces', interfaces,
                            (iface) => {
                                const div = document.createElement('div');
                                div.className = 'card';
                                div.style.marginBottom = '0';
                                div.style.padding = '15px';
                                div.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span class="iface-name" style="font-weight: bold; color: var(--accent-cpu);"></span>
                                    <span class="iface-status" style="font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;"></span>
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">
                                    <span style="color: var(--text-dim);">IP:</span> <span class="iface-ip"></span>
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">
                                    <span style="color: var(--text-dim);">Speed:</span> <span class="iface-speed"></span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 0.85rem;">
                                    <div><i class="fas fa-arrow-up" style="color: var(--accent-cpu);"></i> <span class="iface-sent"></span></div>
                                    <div><i class="fas fa-arrow-down" style="color: var(--accent-mem);"></i> <span class="iface-recv"></span></div>
                                </div>
                            `;
                            return div;
                        },
                        (el, iface) => {
                            el.querySelector('.iface-name').innerText = iface.name;
                            const statusEl = el.querySelector('.iface-status');
                            statusEl.innerText = iface.is_up ? 'UP' : 'DOWN';
                            statusEl.style.background = iface.is_up ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 71, 87, 0.2)';
                            statusEl.style.color = iface.is_up ? '#2ed573' : '#ff4757';
                            
                            el.querySelector('.iface-ip').innerText = iface.ip;
                            el.querySelector('.iface-speed').innerText = iface.speed > 0 ? iface.speed + ' Mb/s' : 'N/A';
                            el.querySelector('.iface-sent').innerText = iface.bytes_sent;
                            el.querySelector('.iface-recv').innerText = iface.bytes_recv;
                        }
                    );
                }
            }

            // SSH (General Page)
            if (data.ssh_stats) {
                const statusEl = document.getElementById('general-ssh-status');
                statusEl.innerText = data.ssh_stats.status;
                statusEl.style.color = data.ssh_stats.status === 'Running' ? '#2ed573' : '#ff4757';
                
                document.getElementById('general-ssh-connections').innerText = data.ssh_stats.connections;

                updateList('general-ssh-sessions', data.ssh_stats.sessions,
                    (session) => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        div.style.padding = '4px 0';
                        div.innerHTML = `
                            <div>
                                <span class="ssh-user" style="color: var(--accent-cpu); font-weight: bold;"></span>
                                <span class="ssh-ip" style="color: var(--text-dim); font-size: 0.8em; margin-left: 5px;"></span>
                            </div>
                            <span class="ssh-time" style="color: var(--text-dim); text-align: right;"></span>
                        `;
                        return div;
                    },
                        (el, session) => {
                            el.querySelector('.ssh-user').innerText = session.user || '-';
                            el.querySelector('.ssh-ip').innerText = session.ip ? `(${session.ip})` : '';
                            
                            let displayTime = session.started;
                            if (session.started && session.started !== '-' && session.started !== 0) {
                                try {
                                    const date = new Date(typeof session.started === 'number' ? session.started : session.started);
                                    displayTime = date.toLocaleString();
                                } catch (e) {
                                    displayTime = session.started;
                                }
                            }
                            el.querySelector('.ssh-time').innerText = displayTime || '-';
                        }
                );
                
                if (data.ssh_stats.sessions.length === 0) {
                    const container = document.getElementById('general-ssh-sessions');
                    if (container.innerHTML === '') {
                         container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 10px;">No active sessions</div>';
                    } else if (container.children.length > 0 && !container.querySelector('.ssh-user')) {
                         // Keep "No active sessions" if it's already there and we have no data
                    } else {
                         container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 10px;">No active sessions</div>';
                    }
                }
            }

            // Disk (General Page)
            if (data.disk) {
                updateList('disk-container', data.disk,
                (disk) => {
                    const div = document.createElement('div');
                    div.className = 'disk-item';
                    div.innerHTML = `
                        <div class="stat-label">
                            <span class="disk-mount"></span>
                            <span class="disk-percent"></span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-fill disk-fill" style="width: 0%"></div>
                        </div>
                        <div class="disk-info">
                            <span class="disk-device"></span>
                            <span class="disk-usage"></span>
                        </div>
                    `;
                    return div;
                },
                (el, disk) => {
                    el.querySelector('.disk-mount').innerText = disk.mountpoint;
                    el.querySelector('.disk-percent').innerText = disk.percent + '%';
                    el.querySelector('.disk-fill').style.width = disk.percent + '%';
                    el.querySelector('.disk-device').innerText = disk.device;
                    el.querySelector('.disk-usage').innerText = `${disk.used} used of ${disk.total}`;
                }
            );
            }

            // Storage Page
            const isStoragePage = document.getElementById('page-storage').classList.contains('active');
            if (isStoragePage && data.disk) {
                // Disk Overview - Aggregate by device
                const deviceMap = {};
                data.disk.forEach(disk => {
                    if (!deviceMap[disk.device]) {
                        deviceMap[disk.device] = {
                            device: disk.device,
                            total: disk.total,
                            used: disk.used,
                            free: disk.free,
                            percent: disk.percent,
                            mounts: []
                        };
                    }
                    deviceMap[disk.device].mounts.push(disk.mountpoint);
                });
                
                const devices = Object.values(deviceMap);
                updateList('disk-overview', devices,
                    (dev) => {
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.style.padding = '15px';
                        div.style.marginBottom = '0';
                        div.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 10px; color: var(--accent-disk);" class="dev-name"></div>
                            <div class="progress-bg" style="height: 12px; margin-bottom: 8px;">
                                <div class="progress-fill disk-fill" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                                <span class="dev-used"></span>
                                <span class="dev-percent"></span>
                            </div>
                        `;
                        return div;
                    },
                    (el, dev) => {
                        el.querySelector('.dev-name').innerText = dev.device;
                        el.querySelector('.disk-fill').style.width = dev.percent + '%';
                        el.querySelector('.dev-used').innerText = `${dev.used} / ${dev.total}`;
                        el.querySelector('.dev-percent').innerText = dev.percent + '%';
                    }
                );

                // Partitions List
                updateList('storage-partitions', data.disk,
                    (disk) => {
                        const div = document.createElement('div');
                        div.style.background = 'rgba(255,255,255,0.03)';
                        div.style.padding = '15px';
                        div.style.borderRadius = '8px';
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; color: var(--accent-cpu);" class="part-mount"></div>
                                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 2px;" class="part-device"></div>
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold;" class="part-percent"></div>
                            </div>
                            <div class="progress-bg" style="height: 8px; margin-bottom: 8px;">
                                <div class="progress-fill disk-fill" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim);">
                                <span class="part-usage"></span>
                                <span class="part-free"></span>
                            </div>
                        `;
                        return div;
                    },
                    (el, disk) => {
                        el.querySelector('.part-mount').innerText = disk.mountpoint;
                        el.querySelector('.part-device').innerText = disk.device;
                        el.querySelector('.part-percent').innerText = disk.percent + '%';
                        el.querySelector('.disk-fill').style.width = disk.percent + '%';
                        el.querySelector('.part-usage').innerText = `Used: ${disk.used}`;
                        el.querySelector('.part-free').innerText = `Free: ${disk.free}`;
                    }
                );
            }

            // Disk I/O Stats
            if (isStoragePage && data.disk_io) {
                const ioList = Object.entries(data.disk_io).map(([name, stats]) => ({name, ...stats}));
                
                const container = document.getElementById('disk-io-stats');
                if (ioList.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No I/O data available</div>';
                } else {
                    container.innerHTML = '';
                    ioList.forEach(io => {
                        const div = document.createElement('div');
                        div.className = 'process-item level-0';
                        div.style.cursor = 'default';
                        
                        div.innerHTML = `
                            <div class="process-info">
                                <div class="process-name">${io.name}</div>
                                <div class="process-meta">
                                    Read: ${io.read_bytes} (${io.read_count.toLocaleString()} ops) • 
                                    Write: ${io.write_bytes} (${io.write_count.toLocaleString()} ops)
                                </div>
                            </div>
                            <div class="process-bars" style="display: flex; gap: 15px; align-items: center;">
                                <div style="min-width: 80px;">
                                    <div style="font-size: 0.75rem; color: var(--text-dim);">Read Ops</div>
                                    <div style="font-size: 0.9rem; font-weight: bold; color: var(--accent-net);">${(io.read_count / 1000).toFixed(1)}k</div>
                                </div>
                                <div style="min-width: 80px;">
                                    <div style="font-size: 0.75rem; color: var(--text-dim);">Write Ops</div>
                                    <div style="font-size: 0.9rem; font-weight: bold; color: var(--accent-disk);">${(io.write_count / 1000).toFixed(1)}k</div>
                                </div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            }

            // Inode Usage
            if (isStoragePage && data.inodes) {
                const container = document.getElementById('inode-usage');
                if (data.inodes.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No inode data available</div>';
                } else {
                    container.innerHTML = '';
                    data.inodes.forEach(inode => {
                        const div = document.createElement('div');
                        div.style.padding = '15px';
                        div.style.background = 'rgba(255,255,255,0.05)';
                        div.style.borderRadius = '8px';
                        div.style.borderLeft = '4px solid var(--accent-disk)';
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">${inode.mountpoint}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-dim);">
                                        ${inode.used.toLocaleString()} / ${inode.total.toLocaleString()} inodes
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; font-size: 1.2rem; color: ${inode.percent > 80 ? '#ff4757' : 'var(--accent-mem)'};">${inode.percent}%</div>
                                    <div style="font-size: 0.8rem; color: var(--text-dim);">${inode.free.toLocaleString()} free</div>
                                </div>
                            </div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${inode.percent}%; background: ${inode.percent > 80 ? '#ff4757' : 'var(--accent-disk)'}"></div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            }

            // SSH Page Rendering (always update, not just when page is active)
            if (data.ssh_stats) {
                const ssh = data.ssh_stats;

                // SSH Status
                const statusEl = document.getElementById('ssh-status');
                if (statusEl) {
                    statusEl.innerText = ssh.status || 'Unknown';
                    statusEl.style.color = 
                        ssh.status === 'Running' ? 'var(--accent-memory)' : '#ff4757';
                }

                // SSH Connections
                const connEl = document.getElementById('ssh-connections');
                if (connEl) connEl.innerText = ssh.connections || 0;

                // SSH Memory
                const memEl = document.getElementById('ssh-memory');
                if (memEl) memEl.innerText = 
                    ssh.ssh_process_memory ? ssh.ssh_process_memory.toFixed(2) + '%' : '-';

                // Failed Logins
                const failedEl = document.getElementById('ssh-failed-logins');
                if (failedEl) failedEl.innerText = ssh.failed_logins || 0;

                // Active Sessions
                const sessContainer = document.getElementById('ssh-sessions');
                if (sessContainer) {
                    if (!ssh.sessions || ssh.sessions.length === 0) {
                        sessContainer.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No active sessions</div>';
                    } else {
                        sessContainer.innerHTML = '';
                        ssh.sessions.forEach(session => {
                            const div = document.createElement('div');
                            div.className = 'process-item level-0';
                            div.style.padding = '12px';
                            div.style.background = 'rgba(255,255,255,0.05)';
                            div.style.borderRadius = '6px';
                            
                            // Convert UTC time to local time (same as General page)
                            let displayTime = session.started;
                            if (session.started && session.started !== '-' && session.started !== 0) {
                                try {
                                    const date = new Date(typeof session.started === 'number' ? session.started : session.started);
                                    displayTime = date.toLocaleString();
                                } catch (e) {
                                    displayTime = session.started;
                                }
                            }
                            
                            div.innerHTML = `
                                <div class="process-name">${session.user}@${session.ip}</div>
                                <div class="process-meta">Connected: ${displayTime}</div>
                            `;
                            sessContainer.appendChild(div);
                        });
                    }
                }

                // Auth Methods
                const authContainer = document.getElementById('ssh-auth-methods');
                if (authContainer && ssh.auth_methods) {
                    authContainer.innerHTML = `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: var(--text-dim);">Public Key</span>
                            <span style="font-weight: bold; color: var(--accent-network);">${ssh.auth_methods.publickey || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: var(--text-dim);">Password</span>
                            <span style="font-weight: bold; color: var(--accent-disk);">${ssh.auth_methods.password || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span style="color: var(--text-dim);">Other Methods</span>
                            <span style="font-weight: bold; color: var(--accent-cpu);">${ssh.auth_methods.other || 0}</span>
                        </div>
                    `;
                }

                // Host Key Fingerprint
                const hostKeyEl = document.getElementById('ssh-hostkey');
                if (hostKeyEl) hostKeyEl.innerText = ssh.hostkey_fingerprint || '-';

                // Known Hosts
                const historyEl = document.getElementById('ssh-history');
                if (historyEl) {
                    if (ssh.history_size !== undefined && ssh.history_size !== null) {
                        historyEl.innerText = `${ssh.history_size} entries`;
                    } else {
                        historyEl.innerText = '-';
                    }
                }

                // OOM Risk Processes
                const oomContainer = document.getElementById('ssh-oom-processes');
                if (oomContainer) {
                    if (!ssh.oom_risk_processes || ssh.oom_risk_processes.length === 0) {
                        oomContainer.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">All processes within safe memory range</div>';
                    } else {
                        oomContainer.innerHTML = '';
                        ssh.oom_risk_processes.forEach(proc => {
                            const div = document.createElement('div');
                            div.style.padding = '12px';
                            div.style.background = 'rgba(255,107,107,0.1)';
                            div.style.borderRadius = '6px';
                            div.style.borderLeft = '4px solid #FF6B6B';
                            div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold;">${proc.name}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-dim);">PID: ${proc.pid}</div>
                                    </div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #FF6B6B;">${proc.memory}%</div>
                                </div>
                            `;
                            oomContainer.appendChild(div);
                        });
                    }
                }
            }
        }
    }

        // 检查认证
        function checkAuthentication() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return token;
        }

        // 获取认证 Token
        function getAuthToken() {
            return localStorage.getItem('auth_token');
        }

        // 登出函数
        async function logout() {
            const token = getAuthToken();
            if (token) {
                try {
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (err) {
                    console.error('Logout error:', err);
                }
            }
            // 清除本地存储
            localStorage.removeItem('auth_token');
            // 跳转到登录页
            window.location.href = '/login';
        }

        // 拦截 fetch 请求添加认证头
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const token = getAuthToken();
            let options = args[1] || {};
            if (!options.headers) {
                options.headers = {};
            }
            // 为 API 请求添加 Authorization header
            if (token && (args[0].includes('/api/') || args[0].includes('/ws/'))) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            args[1] = options;

			return originalFetch.apply(window, args).then((res) => {
				// token 失效/缺失时，自动清理并跳转到登录页
				if (res && res.status === 401) {
					try {
						localStorage.removeItem('auth_token');
						localStorage.removeItem('username');
						localStorage.removeItem('role');
					} catch (_) {}

					if (window.location.pathname !== '/login') {
						window.location.href = '/login';
					}
				}
				return res;
			});
        };

        // 添加登出按钮到侧边栏
        document.addEventListener('DOMContentLoaded', function() {
            // 检查认证
            const token = checkAuthentication();
            if (!token) return;

            // 在侧边栏底部添加登出按钮
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                const logoutBtn = document.createElement('button');
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> <span>Log out</span>';
                logoutBtn.className = 'nav-item';
                logoutBtn.style.marginTop = '10px';
                logoutBtn.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                logoutBtn.style.paddingTop = '20px';
                logoutBtn.style.cursor = 'pointer';
                logoutBtn.onclick = (e) => {
                    e.preventDefault();
                    logout();
                };
                sidebar.appendChild(logoutBtn);
            }

            // 启动 WebSocket 连接
            connectWebSocket();

            // === SERVICE WORKER REGISTRATION ===
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                            
                            // Check for updates periodically
                            setInterval(() => {
                                registration.update();
                            }, 60000); // Check every minute
                        })
                        .catch(err => {
                            console.log('Service Worker registration failed:', err);
                        });
                });

                // Handle updates
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Service Worker controller changed - app updated');
                    // Show toast notification for update
                    const msg = document.createElement('div');
                    msg.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: #2ed573;
                        color: #1a1a1a;
                        padding: 15px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    `;
                    msg.textContent = '✓ App updated. Refresh to see changes.';
                    document.body.appendChild(msg);
                    setTimeout(() => msg.remove(), 5000);
                });
            }

            // === PWA INSTALL PROMPT ===
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button
                const installBtn = document.createElement('button');
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: #00a8ff;
                    color: #1a1a1a;
                    padding: 10px 20px;
                    border-radius: 8px;
                    border: none;
                    font-weight: bold;
                    cursor: pointer;
                    z-index: 9999;
                    font-size: 14px;
                    transition: all 0.3s ease;
                `;
                installBtn.innerHTML = '📱 Install App';
                installBtn.onmouseover = () => {
                    installBtn.style.transform = 'scale(1.05)';
                    installBtn.style.boxShadow = '0 0 15px rgba(0, 168, 255, 0.5)';
                };
                installBtn.onmouseout = () => {
                    installBtn.style.transform = 'scale(1)';
                    installBtn.style.boxShadow = 'none';
                };
                
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response: ${outcome}`);
                        deferredPrompt = null;
                        installBtn.remove();
                    }
                });
                
                // Only show on non-installed scenarios
                if (!window.matchMedia('(display-mode: standalone)').matches && 
                    !navigator.standalone) {
                    document.body.appendChild(installBtn);
                }
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                deferredPrompt = null;
            });
        });
    </script>
</body>
</html>
