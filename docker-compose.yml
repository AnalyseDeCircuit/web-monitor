services:
  web-monitor-go:
    build:
      context: .
      dockerfile: Dockerfile
    image: web-monitor-go:latest
    container_name: web-monitor-go
    # privileged: true
    cap_add:
      - SYS_PTRACE        # 读取 /proc 进程信息
      - DAC_READ_SEARCH   # 读取任意文件 (如 /var/log/auth.log)
      - SYS_CHROOT        # 执行 chroot (用于 Cron 管理)
    security_opt:
      - apparmor=unconfined
    network_mode: host
    pid: host
    environment:
      - PORT=38080
      - LANG
      - DATA_DIR=/data
      - JWT_SECRET=${JWT_SECRET}
      - WS_ALLOWED_ORIGINS=${WS_ALLOWED_ORIGINS}
      # Docker API: talk to Docker ONLY through the local proxy (no docker.sock mount in this container).
      - DOCKER_HOST=${DOCKER_HOST:-tcp://127.0.0.1:2375}
      # Host Filesystem Configuration
      - HOST_FS=/hostfs
      - HOST_PROC=/hostfs/proc
      - HOST_SYS=/hostfs/sys
      - HOST_ETC=/hostfs/etc
      - HOST_VAR=/hostfs/var
      - HOST_RUN=/hostfs/run
      # Systemd D-Bus Connection
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/run/dbus/system_bus_socket
      # NVIDIA GPU Support (Dynamic)
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      
      # --- Modules Configuration (Optional, default is true) ---
      - ENABLE_CPU=${ENABLE_CPU:-true}
      - ENABLE_MEMORY=${ENABLE_MEMORY:-true}
      - ENABLE_DISK=${ENABLE_DISK:-true}
      - ENABLE_NETWORK=${ENABLE_NETWORK:-true}
      - ENABLE_SENSORS=${ENABLE_SENSORS:-true}
      - ENABLE_POWER=${ENABLE_POWER:-true}
      - ENABLE_GPU=${ENABLE_GPU:-true}
      - ENABLE_SSH=${ENABLE_SSH:-true}
      - ENABLE_SYSTEM=${ENABLE_SYSTEM:-true}
      - ENABLE_DOCKER=${ENABLE_DOCKER:-true}
      - ENABLE_CRON=${ENABLE_CRON:-true}
      - ENABLE_SYSTEMD=${ENABLE_SYSTEMD:-true}
    volumes:
      - /:/hostfs
      - /sys:/sys
      - /proc:/proc
      - /var/run/utmp:/var/run/utmp:ro
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      # Plugins configuration (single file) + SSH materials for SSH/SFTP-based plugins.
      # IMPORTANT: These files must exist on the host BEFORE starting the container.
      # If file doesn't exist, Docker creates a directory instead, breaking the config.
      # Uncomment these lines after running: scripts/setup_host_plugins.sh
      # - /etc/webmonitor/plugins.json:/etc/webmonitor/plugins.json:ro
      # - /etc/webmonitor/webshell_id_ed25519:/etc/webmonitor/webshell_id_ed25519:ro
      # - /etc/webmonitor/filemanager_id_ed25519:/etc/webmonitor/filemanager_id_ed25519:ro
      # - /etc/webmonitor/known_hosts:/etc/webmonitor/known_hosts:ro
      - web-monitor-data:/data
    restart: unless-stopped

  # --- Plugins (Docker-managed) ---
  # These containers are intended to be started/stopped by the main server via docker-proxy.
  # Create them with: docker compose up -d --no-start plugin-webshell plugin-filemanager
  plugin-webshell:
    build:
      context: .
      dockerfile: plugins/docker/webshell/Dockerfile
    image: web-monitor-plugin-webshell:latest
    container_name: web-monitor-plugin-webshell
    restart: "no"
    ports:
      - "127.0.0.1:38101:8080"
    environment:
      - WEBMONITOR_PLUGINS_CONFIG=/etc/webmonitor/plugins.json
      - PLUGIN_PORT=8080
    volumes:
      - /etc/webmonitor/plugins.json:/etc/webmonitor/plugins.json:ro
      - /etc/webmonitor/webshell_id_ed25519:/etc/webmonitor/webshell_id_ed25519:ro
      - /etc/webmonitor/known_hosts:/etc/webmonitor/known_hosts:ro

  plugin-filemanager:
    build:
      context: .
      dockerfile: plugins/docker/filemanager/Dockerfile
    image: web-monitor-plugin-filemanager:latest
    container_name: web-monitor-plugin-filemanager
    restart: "no"
    ports:
      - "127.0.0.1:38102:8082"
    environment:
      - WEBMONITOR_PLUGINS_CONFIG=/etc/webmonitor/plugins.json
      - PLUGIN_PORT=8082
    volumes:
      - /etc/webmonitor/plugins.json:/etc/webmonitor/plugins.json:ro
      - /etc/webmonitor/filemanager_id_ed25519:/etc/webmonitor/filemanager_id_ed25519:ro
      - /etc/webmonitor/known_hosts:/etc/webmonitor/known_hosts:ro

  # Optional sidecar: restrict Docker API surface while keeping Docker Management working.
  # Exposes TCP 2375 on localhost only. Enable by setting DOCKER_HOST=tcp://127.0.0.1:2375 for web-monitor-go.
  docker-socket-proxy:
    build:
      context: .
      dockerfile: Dockerfile.docker-proxy
    container_name: docker-socket-proxy
    restart: unless-stopped
    mem_limit: 16m
    ports:
      - "127.0.0.1:2375:2375"
    environment:
      - DOCKER_SOCK=/var/run/docker.sock
      # Encourage a lower steady-state RSS for this tiny proxy.
      - GOMEMLIMIT=10MiB
      - GOGC=25
      - GODEBUG=madvdontneed=1
    volumes:
      # Map the host's docker socket (including rootless) to the path expected by the proxy.
      - ${DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock


volumes:
  web-monitor-data:
    driver: local
